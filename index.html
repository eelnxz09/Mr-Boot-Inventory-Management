<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mr Boot">
    <meta name="theme-color" content="#4E342E">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png">
    <title>Mr Boot Manager (Online)</title>
    <!-- HEIC Conversion Library -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        :root {
            /* Palette */
            --primary: #4E342E; 
            --primary-dark: #281A16;
            --accent: #D7CCC8;
            --bg-app: #F2F4F8;
            --bg-card: #FFFFFF;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --success: #34C759;
            --warning: #FF9F0A;
            --danger: #FF3B30;
            --info: #007AFF;
            --nav-h: 80px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-app); 
            color: var(--text-main); 
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Login Screen */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; padding: 24px; transition: transform 0.3s ease-in-out;
        }
        #login-screen.hidden { transform: translateY(-100%); }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; backdrop-filter: blur(5px);
        }
        #loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid transparent;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layout */
        header {
            height: 70px; background: var(--bg-card); flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100;
        }
        .header-logo { height: 45px; width: auto; object-fit: contain; }
        .app-title h1 { font-size: 20px; font-weight: 700; margin: 0; color: var(--primary); letter-spacing: -0.5px; }
        
        main { 
            flex: 1; 
            overflow-y: auto; 
            scroll-behavior: smooth; 
            position: relative; 
            padding: 10px 16px 120px 16px; 
        }
        
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation */
        nav {
            background: white; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-h);
            display: flex; z-index: 2000;
            padding-bottom: env(safe-area-inset-bottom);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; text-decoration: none; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        .nav-item span { font-size: 10px; }

        /* Components */
        .card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .badge { display: inline-flex; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .bg-pending { background: #FFF4E5; color: #FF9500; }
        .bg-ready { background: #E8F5E9; color: #34C759; }
        .bg-completed { background: #E5F1FF; color: #007AFF; }
        
        .fab {
            position: fixed; bottom: 100px; right: 20px;
            width: 56px; height: 56px; border-radius: 18px;
            background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(78, 52, 46, 0.4);
            z-index: 1500; cursor: pointer; border: none;
        }

        /* Forms */
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px;
            border: 1px solid #E5E5EA; border-radius: 10px;
            font-size: 16px; background: #F9F9F9; -webkit-appearance: none;
        }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-whatsapp { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background: #999; }
        
        .flex-row { display: flex; gap: 10px; flex-wrap: wrap; }
        #order-action-bar { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-start; }
        .hidden { display: none !important; }
        .img-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; margin-right: 8px; cursor: pointer; }
        
        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 3000; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .modal.open { transform: translateY(0); }
        .modal-header { padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 16px; flex: 1; overflow-y: auto; }
        .close-btn { background: #F2F2F7; width: 30px; height: 30px; border-radius: 50%; border: none; font-size: 18px; }

        /* Item Row */
        .item-row { background: white; border: 1px solid #eee; padding: 10px; border-radius: 10px; margin-bottom: 10px; position: relative; }
        .remove-item { position: absolute; top: 5px; right: 5px; color: red; background: none; border: none; font-size: 20px; }
        
        /* Service Selection Styling (Tick Mark) */
        .service-option-label {
            display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; 
            border-bottom: 1px solid #eee; cursor: pointer; background: white; transition: background 0.2s;
        }
        .service-option-label:active { background: #f9f9f9; }
        .service-option-label input { display: none; }
        .service-text { font-size: 16px; color: #333; }
        .service-option-label input:checked ~ .service-text { font-weight: 600; color: var(--primary); }
        .service-tick { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s; }
        .service-option-label input:checked ~ .service-tick { background: var(--success); border-color: var(--success); }
        .service-tick svg { width: 16px; height: 16px; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .service-option-label input:checked ~ .service-tick svg { opacity: 1; transform: scale(1); }
        
        /* AI Assistant Styles */
        .ai-message { padding: 12px; margin-bottom: 12px; border-radius: 12px; max-width: 85%; animation: slideIn 0.3s ease; }
        .ai-user { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: auto; text-align: right; }
        .ai-assistant { background: #f0f0f0; color: #333; margin-right: auto; }
        .ai-loading { background: #f0f0f0; color: #999; margin-right: auto; font-style: italic; }
        .ai-quick-btn { background: white; border: 2px solid #667eea; color: #667eea; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .ai-quick-btn:hover { background: #667eea; color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Bulk Actions Bar */
        #bulk-actions-bar {
            position: fixed; bottom: 100px; left: 16px; right: 16px;
            background: #333; color: white; padding: 12px 20px;
            border-radius: 50px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1600;
            transform: translateY(150px); transition: transform 0.3s;
        }
        #bulk-actions-bar.visible { transform: translateY(0); }

        /* Order Card Selection */
        .card.selecting { border: 2px solid var(--primary); background: #fffcf8; }
        .checkbox-overlay {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #ddd;
            display: flex; align-items: center; justify-content: center; margin-right: 12px;
        }
        .card.selecting .checkbox-overlay { background: var(--primary); border-color: var(--primary); }
        .card.selecting .checkbox-overlay::after { content: '‚úì'; color: white; font-size: 14px; }
        
        /* Gallery */
        .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gallery-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 4/5; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-caption { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 8px; font-size: 12px; font-weight: bold; }
        .gallery-delete { position: absolute; top: 5px; right: 5px; background: rgba(255,59,48,0.9); color: white; width: 24px; height: 24px; border-radius: 50%; border:none; display: flex; align-items: center; justify-content: center;}

    </style>
    <!-- GLOBAL ERROR HANDLER -->
    <script>
        window.onerror = function(msg, url, line) {
            // alert("App Error: " + msg + "\nLine: " + line);
        };
    </script>
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <div id="loading-text">Processing...</div>
    </div>

    <!-- BULK ACTIONS BAR -->
    <div id="bulk-actions-bar">
        <span><span id="bulk-count">0</span> Selected</span>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" style="color:white; border-color:white; margin:0; padding:6px 12px; font-size:12px;" onclick="window.performBulkAction('Ready')">Mark Ready</button>
            <button class="btn btn-outline" style="color:#FF3B30; border-color:#FF3B30; margin:0; padding:6px 12px; font-size:12px;" onclick="window.performBulkAction('Delete')">Delete</button>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen">
        <h1 style="font-size:32px; margin-bottom:40px;">Mr Boot</h1>
        <div class="card" style="width:100%; max-width:320px; background:white; color:#333;">
            <h3 style="margin-top:0;">Shop Login</h3>
            <p style="font-size:12px; color:#666;">Enter Email & Password to Sync Data.</p>
            
            <input type="email" id="login-email" placeholder="Email Address" style="margin-bottom:10px;">
            <input type="password" id="login-password" placeholder="Password" style="margin-bottom:16px;">
            
            <button id="login-btn" class="btn btn-primary" onclick="window.loginWithEmail()">Login</button>
            <button id="register-btn" class="btn btn-outline" style="margin-top:10px;" onclick="window.registerWithEmail()">Create New Account</button>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <!-- Logo -->
            <img id="header-logo" src="https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png" class="header-logo" onerror="this.style.display='none'; document.getElementById('header-text').style.display='block';">
            <div id="header-text" class="app-title" style="display:none;">
                <h1>Mr Boot</h1>
                <span style="font-size:10px; color:var(--text-sub);">Inventory & Service</span>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <button id="install-btn" style="display:none; background:#4E342E; color:white; border:none; padding:6px 12px; border-radius:8px; font-size:11px; cursor:pointer;">üì± Install App</button>
            <div id="db-status" style="width:8px; height:8px; border-radius:50%; background:#ccc;"></div>
            <span id="user-email-display" style="font-size:10px; color:#666; max-width:80px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;"></span>
            <button onclick="window.logout()" style="background:none; border:none; font-size:12px; color:red;">Exit</button>
        </div>
    </header>

    <!-- HIDDEN CANVAS & RESOURCES -->
    <canvas id="billCanvas" style="display:none;"></canvas>
    <!-- Direct link for canvas. MUST BE CORS enabled or base64 -->
    <img id="logo-img-res" src="https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png" crossorigin="anonymous" style="display:none;">

    <main>
        <!-- ORDERS -->
        <section id="view-orders" class="view active">
            <div id="delivery-alert" class="card hidden" style="background:#E8F5E9; color:#2E7D32; font-weight:bold;">
                üöö Today's Delivery: <span id="delivery-count">0</span> orders
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <input type="text" id="order-search" placeholder="Search Order ID, Name, Mobile..." oninput="window.renderOrders()" style="margin-bottom:0;">
            </div>

            <div class="flex-row" style="overflow-x:auto; padding-bottom:8px; margin-bottom:8px; align-items:center;">
                <button id="btn-select-mode" class="btn btn-outline" style="width:auto; margin:0; padding:6px 10px; font-size:12px;" onclick="window.toggleSelectMode()">Select</button>
                <div style="width:1px; height:20px; background:#ddd; margin:0 5px;"></div>
                <button class="badge" style="background:var(--primary); color:white; border:none;" onclick="window.filterOrders('All')">All</button>
                <button class="badge bg-pending" style="border:none;" onclick="window.filterOrders('Pending')">Pending</button>
                <button class="badge bg-ready" style="border:none;" onclick="window.filterOrders('Ready')">Ready</button>
                <button class="badge bg-completed" style="border:none;" onclick="window.filterOrders('Completed')">Done</button>
            </div>
            
            <div id="orders-list"></div>
            
            <button class="fab" onclick="window.openOrderModal()" style="right:80px;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            
            <button class="fab" onclick="window.startVoiceOrder()" style="background:#FF9500;" title="Voice Order">
                üé§
            </button>
        </section>

        <!-- CUSTOMERS -->
        <section id="view-customers" class="view">
            <div class="search-bar">
                <input type="text" id="customer-search" placeholder="Search Customer Name or Mobile..." oninput="window.renderCustomers()" style="margin-bottom:10px;">
            </div>
            <div id="customers-list"></div>
        </section>

        <!-- INVENTORY -->
        <section id="view-inventory" class="view">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                <h3>Add-ons / Stock</h3>
                <button class="btn btn-primary" style="width:auto; margin:0; padding:8px 16px; font-size:12px;" onclick="window.openInventoryModal()">+ Add Item</button>
            </div>
            <div id="inventory-list"></div>
        </section>

        <!-- GALLERY (NEW) -->
        <section id="view-gallery" class="view">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px; align-items:center;">
                <h3>Showcase</h3>
                <button class="btn btn-primary" style="width:auto; margin:0; padding:8px 16px; font-size:12px;" onclick="document.getElementById('modal-gallery-upload').classList.add('open')">+ Upload</button>
            </div>
            <div id="gallery-list" class="gallery-grid"></div>
        </section>

        <!-- REPORTS -->
        <section id="view-reports" class="view">
            <!-- Language Selector -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:12px; border-radius:10px; margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:white; font-weight:bold;">üåç Language</span>
                <select id="language-selector" onchange="window.changeLanguage(this.value)" style="padding:6px 12px; border-radius:6px; border:none; background:white; cursor:pointer;">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                </select>
            </div>
            
            <div class="card">
                <h3 id="text-financials">Financials</h3>
                <p><span id="text-revenue">Revenue</span>: <b id="rep-revenue">0</b></p>
                <p><span id="text-pending">Pending</span>: <b id="rep-pending" style="color:var(--danger)">0</b></p>
                <p><span id="text-profit">Profit (Net)</span>: <b id="rep-profit" style="color:var(--success)">0</b></p>
            </div>
            
            <!-- Advanced Analytics -->
            <div class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
                <h3 id="text-analytics">üìä Advanced Analytics</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
                    <div style="background:rgba(255,255,255,0.2); padding:12px; border-radius:8px;">
                        <small style="opacity:0.9;" id="text-avg-order">Avg Order Value</small>
                        <h2 style="margin:8px 0 0 0;">‚Çπ<span id="avg-order-value">0</span></h2>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:12px; border-radius:8px;">
                        <small style="opacity:0.9;" id="text-total-orders">Total Orders</small>
                        <h2 style="margin:8px 0 0 0;"><span id="total-orders-count">0</span></h2>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:12px; border-radius:8px;">
                        <small style="opacity:0.9;" id="text-completion-rate">Completion Rate</small>
                        <h2 style="margin:8px 0 0 0;"><span id="completion-rate">0</span>%</h2>
                    </div>
                    <div style="background:rgba(255,255,255,0.2); padding:12px; border-radius:8px;">
                        <small style="opacity:0.9;" id="text-retention-rate">Retention Rate</small>
                        <h2 style="margin:8px 0 0 0;"><span id="retention-rate">0</span>%</h2>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Trends -->
            <div class="card">
                <h3 id="text-revenue-trend">üìà Revenue Trend (Last 30 Days)</h3>
                <canvas id="revenue-chart" style="max-height:250px;"></canvas>
            </div>
            
            <!-- Most Profitable Services -->
            <div class="card">
                <h3 id="text-top-services">üèÜ Top 5 Services by Revenue</h3>
                <div id="top-services-container"></div>
            </div>
            
            <!-- Peak Hours -->
            <div class="card">
                <h3 id="text-peak-hours">‚è∞ Peak Hours Heatmap</h3>
                <p style="font-size:12px; color:#666;" id="text-peak-desc">Orders by hour of day</p>
                <div id="peak-hours-container" style="margin-top:12px;"></div>
            </div>
            
            <div class="card">
                <h3 id="text-daily-calendar">üìÖ Daily Revenue Calendar</h3>
                <p style="font-size:14px; color:#666;" id="text-last-7-days">Last 7 days earnings breakdown</p>
                <div id="daily-revenue-container" style="margin-top:12px;">
                    <!-- Daily revenue will be populated here -->
                </div>
            </div>
            
            <!-- Backup & Restore -->
            <div class="card" style="background:#E8F5E9; border-left:4px solid #4CAF50;">
                <h3 style="color:#2E7D32;" id="text-backup">üíæ Backup & Restore</h3>
                <p style="font-size:13px; color:#666;" id="text-backup-desc">Protect your data with automatic backups</p>
                <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                    <button class="btn" style="background:#4CAF50; color:white;" onclick="window.backupToGoogleDrive()" id="btn-backup">üì§ Backup to Google Drive</button>
                    <button class="btn btn-outline" onclick="window.exportAllData()" id="btn-export">üìä Export to Excel</button>
                    <button class="btn btn-outline" onclick="window.restoreFromBackup()" id="btn-restore">üì• Restore Backup</button>
                </div>
                <small style="display:block; color:#666; margin-top:8px;" id="text-last-backup">Last backup: <span id="last-backup-time">Never</span></small>
            </div>
            
            <div class="card" style="background:#FFF3CD; border-left: 4px solid #FF9500;">
                <h3 style="color:#856404;" id="text-reminders">‚ö†Ô∏è Due Date Reminders</h3>
                <p style="font-size:14px; color:#666;" id="text-check-tomorrow">Check which orders are due tomorrow</p>
                <button class="btn btn-primary" onclick="window.checkDueDateReminders()" id="btn-check-orders">Check Tomorrow's Orders</button>
                <div style="margin-top:12px; padding:10px; background:#FFE5B4; border-radius:6px;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
                        <input type="checkbox" id="auto-reminder-toggle" onchange="window.toggleAutoReminders(this.checked)">
                        <span id="text-auto-whatsapp">üì± Auto-send WhatsApp reminders to admin</span>
                    </label>
                    <small style="color:#666; display:block; margin-top:4px;" id="text-sends-to">Sends directly to +91 9028983659 (no confirmation needed)</small>
                </div>
            </div>
            
            <div class="card">
                <h3 id="text-system">System Status</h3>
                <p style="font-size:12px; color:#666;" id="text-secure">Data is securely stored in Firebase.</p>
                <p style="font-size:11px; color:var(--info);" id="text-network">Network: <span id="net-status">Unknown</span></p>
                <button class="btn btn-primary" onclick="window.testConnection()" id="btn-test">Test Database Connection</button>
                <button class="btn btn-outline" onclick="location.reload()" id="btn-refresh">Refresh App</button>
            </div>
        </section>
    </main>

    <!-- NAV -->
    <nav>
        <a href="#" class="nav-item active" onclick="window.switchView('orders', this)">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            <span>Orders</span>
        </a>
        <a href="#" class="nav-item" onclick="window.switchView('customers', this)">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Customers</span>
        </a>
        <a href="#" class="nav-item" onclick="window.switchView('gallery', this)">
             <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <span>Gallery</span>
        </a>
        <a href="#" class="nav-item" id="nav-inventory" onclick="window.switchView('inventory', this)">
            <svg viewBox="0 0 24 24"><path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
            <span>Add-ons</span>
        </a>
        <a href="#" class="nav-item" id="nav-reports" onclick="window.switchView('reports', this)">
            <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
            <span>Reports</span>
        </a>
    </nav>

    <!-- ORDER MODAL -->
    <div id="modal-order" class="modal">
        <div class="modal-header"><h3>New Order</h3><button class="close-btn" onclick="window.closeModal('modal-order')">&times;</button></div>
        <div class="modal-body">
            <form id="order-form">
                <div class="card" style="background:#F9F9F9; border:none;">
                    <label>Customer</label>
                    <input type="tel" id="ord-phone" placeholder="Mobile" required>
                    <input type="tel" id="ord-whatsapp" placeholder="WhatsApp (leave empty if same as mobile)">
                    <input type="text" id="ord-name" placeholder="Name" required>
                    <textarea id="ord-address" rows="2" placeholder="Address"></textarea>
                </div>
                <div style="background:#E3F2FD; padding:10px; border-radius:10px; margin-bottom:10px;">
                    <label style="color:#1976D2; font-size:12px;">üìÖ Order Date (Optional - for backdating)</label>
                    <input type="date" id="ord-date-created" style="margin:0; background:white;" title="Leave empty for today's date">
                    <small style="color:#666; display:block; margin-top:4px;">Leave empty for today, or select past date for backdating</small>
                </div>
                <div style="background:#FFF3E0; padding:10px; border-radius:10px; margin-bottom:16px;">
                    <label style="color:#E65100;">Due Date</label>
                    <input type="date" id="ord-date-delivery" style="margin:0; background:white;">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>Items</label>
                    <button type="button" class="btn btn-primary" style="width:auto; padding:6px 12px; margin:0; font-size:12px;" onclick="window.addOrderItem()">+ Add Shoe</button>
                </div>
                <div id="order-items-container"></div>

                <label style="margin-top:16px;">Photos</label>
                <div style="background:#E5F1FF; padding:12px; border-radius:10px; margin-bottom:12px; border: 1px dashed #007AFF;">
                    <label style="color:#007AFF; font-weight:bold;">üì∏ Main Photo (For Bill)</label>
                    <input type="file" id="ord-main-image" accept="image/*" style="margin-bottom:0;">
                </div>
                <label>Additional Photos</label>
                <input type="file" id="ord-images" multiple accept="image/*" onchange="window.validateImageCount(this, 20)">

                <select id="ord-stock-item" style="margin-top:12px;" onchange="window.calcBalance()"><option value="">-- Select Add-on --</option></select>
                <label style="margin-top:16px;">Delivery</label>
                <select id="ord-delivery-mode" onchange="window.toggleDeliveryFields()"><option value="Walk-in">Walk-in</option><option value="Pickup">Pickup & Drop</option></select>
                <div id="delivery-fields" class="hidden">
                    <input type="number" id="ord-porter-cost" placeholder="Porter Cost (Expense)">
                    <input type="number" id="ord-delivery-charge" placeholder="Delivery Charge (Income)" oninput="window.calcBalance()">
                </div>
                <label>Billing</label>
                <div class="flex-row">
                    <input type="number" id="ord-item-total" placeholder="Subtotal" readonly style="background:#eee;">
                    <input type="number" id="ord-advance" placeholder="Advance" oninput="window.calcBalance()">
                </div>
                <div style="text-align:right; font-weight:bold; font-size:18px; margin-bottom:16px;">
                    Balance: <span id="ord-balance" style="color:var(--danger)">0</span>
                </div>
                <select id="ord-paymode"><option>Cash</option><option>UPI</option><option>Card</option></select>
                <button type="button" class="btn btn-primary" id="save-order-btn" onclick="window.saveOrder(event)">Save Order</button>
            </form>
        </div>
    </div>

    <div id="modal-service-selector" class="modal" style="z-index: 3100;">
        <div class="modal-header"><h3>Select Services</h3><button class="close-btn" onclick="window.closeModal('modal-service-selector')">&times;</button></div>
        <div class="modal-body" id="service-options-container" style="padding:0;"></div>
        <div style="padding:16px; border-top:1px solid #eee;">
            <div id="other-service-box" style="display:none; margin-bottom:12px;">
                <label style="font-size:12px; color:#666;">Specify "Other" Service:</label>
                <input type="text" id="other-service-input" placeholder="Enter custom service name" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; margin-top:4px;">
            </div>
            <button class="btn btn-primary" onclick="window.saveServiceSelection()">Confirm</button>
        </div>
    </div>

    <div id="modal-view-order" class="modal">
        <div class="modal-header">
            <h3>Details</h3>
            <div style="display:flex; gap:16px; align-items:center;">
                <button class="close-btn" id="edit-order-btn" onclick="window.editOrder()" style="background:none; color:#007AFF; font-size:24px; padding:0;">‚úèÔ∏è</button>
                <button class="close-btn" onclick="window.deleteOrder()" style="background:none; color:#FF3B30; font-size:24px; padding:0;">üóëÔ∏è</button>
                <button class="close-btn" onclick="window.closeModal('modal-view-order')">&times;</button>
            </div>
        </div>
        <div class="modal-body" id="view-order-content"></div>
        <div style="padding:16px; border-top:1px solid #eee;" id="order-action-bar" class="flex-row"></div>
    </div>
    
    <!-- EDIT ORDER MODAL -->
    <div id="modal-edit-order" class="modal">
        <div class="modal-header">
            <h3>Edit Order</h3>
            <button class="close-btn" onclick="window.closeModal('modal-edit-order')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-order-form">
                <div class="card" style="background:#F9F9F9; border:none;">
                    <label>Customer</label>
                    <input type="tel" id="edit-ord-phone" placeholder="Mobile" required>
                    <input type="tel" id="edit-ord-whatsapp" placeholder="WhatsApp (leave empty if same as mobile)">
                    <input type="text" id="edit-ord-name" placeholder="Name" required>
                    <textarea id="edit-ord-address" rows="2" placeholder="Address"></textarea>
                </div>
                
                <div style="background:#FFF3E0; padding:10px; border-radius:10px; margin-bottom:16px;">
                    <label style="color:#E65100;">Due Date</label>
                    <input type="date" id="edit-ord-date-delivery" style="margin:0; background:white;">
                </div>
                
                <label>Status</label>
                <select id="edit-ord-status" style="margin-bottom:16px;">
                    <option value="Pending">Pending</option>
                    <option value="Ready">Ready</option>
                    <option value="Completed">Completed</option>
                </select>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>Items</label>
                    <button type="button" class="btn btn-primary" style="width:auto; padding:6px 12px; margin:0; font-size:12px;" onclick="window.addEditOrderItem()">+ Add Item</button>
                </div>
                <div id="edit-order-items-container"></div>
                
                <label style="margin-top:16px;">Billing</label>
                <div class="flex-row">
                    <input type="number" id="edit-ord-item-total" placeholder="Subtotal" readonly style="background:#eee;">
                    <input type="number" id="edit-ord-advance" placeholder="Advance" oninput="window.calcEditBalance()">
                </div>
                <div style="text-align:right; font-weight:bold; font-size:18px; margin-bottom:16px;">
                    Balance: <span id="edit-ord-balance" style="color:var(--danger)">0</span>
                </div>
                <select id="edit-ord-paymode">
                    <option>Cash</option>
                    <option>UPI</option>
                    <option>Card</option>
                </select>
                
                <div style="background:#E3F2FD; padding:12px; border-radius:10px; margin:16px 0;">
                    <label style="color:#1976D2;">üì∏ Add/Update Photos</label>
                    <small style="display:block; color:#666; margin-bottom:8px;">Main photo:</small>
                    <input type="file" id="edit-main-image" accept="image/*" style="margin-bottom:8px;">
                    <small style="display:block; color:#666; margin-bottom:8px;">Additional photos (max 20):</small>
                    <input type="file" id="edit-additional-images" multiple accept="image/*" onchange="window.validateImageCount(this, 20)">
                    <small style="display:block; color:#999; font-size:11px; margin-top:4px;">Note: New photos will be added to existing ones</small>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="window.saveEditedOrder()">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="modal-proof" class="modal">
        <div class="modal-header"><h3>Complete</h3><button class="close-btn" onclick="window.closeModal('modal-proof')">&times;</button></div>
        <div class="modal-body">
            <p>Upload completion proof:</p>
            <input type="file" id="proof-image" accept="image/*">
            <button class="btn btn-primary" onclick="window.saveProofAndComplete()">Complete</button>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="modal-ai-assistant" class="modal" style="z-index:3200;">
        <div class="modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
            <h3>‚ú® AI Assistant</h3>
            <button class="close-btn" onclick="window.closeModal('modal-ai-assistant')" style="color:white;">&times;</button>
        </div>
        <div class="modal-body" style="padding:0;">
            <div style="padding:16px; background:#f8f9fa; border-bottom:1px solid #ddd;">
                <p style="margin:0; font-size:13px; color:#666;">Ask AI to help you with:</p>
                <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                    <button onclick="window.askAI('price')" class="ai-quick-btn">üí∞ Suggest Price</button>
                    <button onclick="window.askAI('services')" class="ai-quick-btn">üõ†Ô∏è Recommend Services</button>
                    <button onclick="window.askAI('message')" class="ai-quick-btn">üí¨ Write Message</button>
                    <button onclick="window.askAI('report')" class="ai-quick-btn">üìä Analyze Sales</button>
                </div>
            </div>
            <div id="ai-chat-container" style="padding:16px; max-height:400px; overflow-y:auto; min-height:200px;">
                <div class="ai-message ai-assistant">
                    üëã Hi! I'm your AI assistant. I can help you with pricing, service recommendations, customer messages, and business insights!
                </div>
            </div>
            <div style="padding:16px; border-top:1px solid #ddd; background:white;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="ai-input" placeholder="Ask me anything..." style="flex:1; border:2px solid #667eea;" onkeypress="if(event.key==='Enter') window.sendAIMessage()">
                    <button onclick="window.sendAIMessage()" class="btn" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:10px 20px;">Send</button>
                </div>
                <small style="color:#999; font-size:11px; display:block; margin-top:8px;">üí° Powered by Claude AI</small>
            </div>
        </div>
    </div>

    <div id="modal-inventory" class="modal">
        <div class="modal-header"><h3>Add Item</h3><button class="close-btn" onclick="window.closeModal('modal-inventory')">&times;</button></div>
        <div class="modal-body">
            <form onsubmit="window.saveInventory(event)">
                <input type="text" id="inv-name" placeholder="Item Name" required>
                <input type="text" id="inv-brand" placeholder="Brand" required>
                <input type="number" id="inv-qty" placeholder="Qty" required>
                <input type="number" id="inv-price" placeholder="Price" required>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
        </div>
    </div>

    <div id="modal-customer-history" class="modal">
        <div class="modal-header"><h3>History</h3><button class="close-btn" onclick="window.closeModal('modal-customer-history')">&times;</button></div>
        <div class="modal-body" id="customer-history-content"></div>
    </div>

    <div id="modal-image-preview" class="modal" style="z-index: 4000;">
        <div class="modal-header"><h3>View</h3><button class="close-btn" onclick="window.closeModal('modal-image-preview')">&times;</button></div>
        <div class="modal-body" style="background:#000; display:flex; align-items:center; justify-content:center;">
            <img id="preview-full-img" style="max-width:100%; max-height:80vh;">
        </div>
    </div>

    <!-- GALLERY UPLOAD MODAL -->
    <div id="modal-gallery-upload" class="modal">
        <div class="modal-header"><h3>Upload to Gallery</h3><button class="close-btn" onclick="window.closeModal('modal-gallery-upload')">&times;</button></div>
        <div class="modal-body">
            <input type="text" id="gal-caption" placeholder="Caption (e.g., Before & After)">
            <input type="file" id="gal-image" accept="image/*">
            <button class="btn btn-primary" onclick="window.saveGalleryItem()">Upload</button>
        </div>
    </div>

    <!-- STUB FUNCTIONS - Will be replaced when module loads -->
    <script>
        // These prevent "not a function" errors while the module loads
        window.loginWithEmail = () => console.log('Loading...');
        window.registerWithEmail = () => console.log('Loading...');
        window.logout = () => console.log('Loading...');
        window.closeModal = () => {};
        window.saveGalleryItem = () => {};
    </script>

    <!-- Firebase Compat Libraries (No Modules Required) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        console.log('üöÄ App starting with compat libraries...');
        
        // Enhanced error logging
        window.addEventListener('error', (e) => {
            console.error('‚ùå Global Error:', e.error);
            document.body.innerHTML += `<div style="position:fixed;top:0;left:0;right:0;background:red;color:white;padding:20px;z-index:99999;">ERROR: ${e.error?.message || e.message}<br>Check console (F12)</div>`;
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('‚ùå Unhandled Promise Rejection:', e.reason);
            document.body.innerHTML += `<div style="position:fixed;top:50px;left:0;right:0;background:orange;color:white;padding:20px;z-index:99999;">PROMISE ERROR: ${e.reason}<br>Check console (F12)</div>`;
        });
        
        console.log('üì¶ Initializing Firebase...');

        // FIREBASE CONFIG
        console.log('‚öôÔ∏è Initializing Firebase...');
        const firebaseConfig = {
            apiKey: "AIzaSyAFyPxYstLeXFCZkoCJr8NeFRvazMeEju4",
            authDomain: "boot-7e65c.firebaseapp.com",
            projectId: "boot-7e65c",
            storageBucket: "boot-7e65c.firebasestorage.app",
            messagingSenderId: "415900252904",
            appId: "1:415900252904:web:2a139fe13ebce355c8e75d",
            measurementId: "G-3ZXFKPXJPQ"
        };
        
        // Initialize Firebase with compat API
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log('‚úÖ Firebase initialized successfully');
        console.log('üîê Auth object:', auth);
        console.log('üíæ Firestore object:', db);
        
        window.orders = [];
        window.inventory = [];
        window.customers = {};
        window.gallery = [];
        window.selectedOrders = new Set();
        window.isSelectMode = false;
        
        let pendingCompleteId, viewingOrderId, currentServiceInput;
        const REVIEW_LINK = "https://g.page/r/Ce0M0864Elt6EBE/review";
        const ALL_SERVICES = [
            "Standard Laundry", 
            "Premium Deep Clean", 
            "Shoe Polish",
            "Waterproofing",
            "Stain Removal",
            "Odor Treatment",
            "Sole Pasting", 
            "Sole Change", 
            "Heel Change",
            "Heel Repair",
            "Counter Change",
            "Zipper Repair",
            "Zipper Change",
            "Net Change", 
            "Patch Work", 
            "Stitching Repair",
            "Grip Rubber", 
            "Grip TPR", 
            "Tongue Change", 
            "Insole Change",
            "Lace Replacement",
            "Buckle Repair",
            "Strap Repair",
            "Bag Chain Change",
            "Bag Zipper Repair",
            "Bag Handle Repair",
            "Colour Dye",
            "Color Restoration", 
            "Whitening Treatment",
            "Suede Cleaning",
            "Canvas Cleaning",
            "Leather Conditioning",
            "Full Restoration",
            "Customization",
            "Repair",
            "Other"
        ];

        // ===== AUTO-NOTIFICATION FUNCTIONS (Defined early so they're available) =====
        
        // Function to send WhatsApp message (Mobile-optimized)
        function sendAutoWhatsApp(phone, message) {
            const cleanPhone = phone.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(message)}`;
            
            // Mobile-friendly: Use location.href on mobile, window.open on desktop
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // On mobile: Direct navigation works better
                window.location.href = whatsappUrl;
            } else {
                // On desktop: Open in new tab
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Auto-notify when order status changes to "Ready"
        window.notifyCustomerOrderReady = (orderId) => {
            console.log('üîî notifyCustomerOrderReady called for:', orderId);
            const order = window.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }
            
            const itemsList = order.items ? order.items.map(i => `‚Ä¢ ${i.brand || ''} ${i.type}`.trim()).join('\n') : '';
            
            const message = `üéâ Great News ${order.customer.name}!

Your order #${order.seqId} is READY for pickup! ‚ú®

üìã Items:
${itemsList}

üí∞ Balance to Pay: ‚Çπ${order.financials.balance}

üìç Please visit us at your convenience or we can arrange delivery.

üìû Contact: +91 9028983659

Thank you! üôè
- Mr Boot Shoe Laundry & Repair`;
            
            console.log('Message prepared, showing confirm dialog');
            if (confirm("‚úÖ Order marked as Ready!\n\nSend pickup notification to customer?")) {
                console.log('User confirmed, opening WhatsApp');
                const whatsappNumber = order.customer.whatsapp || order.customer.phone;
                sendAutoWhatsApp(whatsappNumber, message);
            } else {
                console.log('User cancelled notification');
            }
        };
        
        // Auto-send bill via WhatsApp after order creation
        window.autoSendBillAfterCreation = async (orderId) => {
            try {
                console.log('üìÑ autoSendBillAfterCreation called for:', orderId);
                const order = window.orders.find(o => o.id === orderId);
                if (!order) {
                    console.error('Order not found:', orderId);
                    return;
                }
                
                // Generate bill first
                await window.shareBill(orderId);
                
                // Wait a moment for bill to download, then prompt for WhatsApp
                setTimeout(() => {
                    const itemsList = order.items ? order.items.map(i => `‚Ä¢ ${i.brand || ''} ${i.type}`.trim()).join('\n') : '';
                    
                    const message = `Hello ${order.customer.name}! 
                    
Your order #${order.seqId} has been received at Mr Boot Shoe Laundry & Repair.

üìã Order Details:
${itemsList}

üí∞ Total Amount: ‚Çπ${order.financials.total}
üíµ Advance Paid: ‚Çπ${order.financials.advance}
üí≥ Balance: ‚Çπ${order.financials.balance}

üìÖ Expected Delivery: ${order.deliveryDate || 'TBD'}

Your bill has been generated. We'll notify you when your order is ready!

Thank you for choosing us! üôè`;
                    
                    if (confirm("Send bill and order confirmation to customer via WhatsApp?")) {
                        sendAutoWhatsApp(order.customer.phone, message);
                    }
                }, 2000);
            } catch(e) {
                console.error("Auto-send error:", e);
            }
        };
        
        // Check for orders due tomorrow and send admin reminders
        window.checkDueDateReminders = (autoSend = false) => {
            console.log('üìÖ Checking due date reminders...');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const dueOrders = window.orders.filter(o => 
                o.deliveryDate === tomorrowStr && 
                o.status !== 'Completed'
            );
            
            console.log(`Found ${dueOrders.length} orders due tomorrow`);
            
            if (dueOrders.length > 0) {
                const ordersList = dueOrders.map(o => 
                    `#${o.seqId} - ${o.customer.name} (${o.customer.phone})`
                ).join('\n');
                
                alert(`‚ö†Ô∏è REMINDER: ${dueOrders.length} order(s) due TOMORROW!\n\n${ordersList}\n\nMake sure they're ready!`);
                
                // Show in a card on dashboard
                const alertDiv = document.getElementById('delivery-alert');
                if (alertDiv) {
                    alertDiv.classList.remove('hidden');
                    alertDiv.style.background = '#FFF3CD';
                    alertDiv.style.color = '#856404';
                    alertDiv.innerHTML = `‚ö†Ô∏è <b>${dueOrders.length} order(s) due TOMORROW!</b> Check Orders tab.`;
                }
                
                // Auto-send WhatsApp to admin if enabled
                if (autoSend || localStorage.getItem('autoReminders') === 'true') {
                    window.sendAdminReminder(dueOrders);
                }
            } else {
                console.log('No orders due tomorrow');
            }
        };
        
        // Send WhatsApp reminder directly to admin (no confirmation)
        window.sendAdminReminder = (dueOrders) => {
            const adminPhone = '9028983659'; // Your number
            
            const orderDetails = dueOrders.map(o => 
                `üì¶ #${o.seqId} - ${o.customer.name}\n   üìû ${o.customer.phone}\n   üí∞ Balance: ‚Çπ${o.financials.balance}\n   Status: ${o.status}`
            ).join('\n\n');
            
            const message = `üîî DUE DATE REMINDER

‚ö†Ô∏è ${dueOrders.length} order(s) due TOMORROW!

${orderDetails}

Make sure these orders are ready for pickup!

- Mr Boot Auto Reminder`;
            
            // Send directly without confirmation
            const whatsappUrl = `https://wa.me/91${adminPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            console.log('üì± Admin reminder sent to WhatsApp');
        };
        
        // Toggle auto-reminders
        window.toggleAutoReminders = (enabled) => {
            localStorage.setItem('autoReminders', enabled ? 'true' : 'false');
            
            if (enabled) {
                alert('‚úÖ Auto-reminders enabled!\n\nYou will receive WhatsApp notifications about due orders automatically.');
                // Run check immediately
                window.checkDueDateReminders(true);
            } else {
                alert('‚ùå Auto-reminders disabled.\n\nYou can still check manually using the button.');
            }
        };
        
        // Load auto-reminder setting on page load
        window.addEventListener('load', () => {
            const toggle = document.getElementById('auto-reminder-toggle');
            if (toggle) {
                toggle.checked = localStorage.getItem('autoReminders') === 'true';
            }
        });
        
        // Request Google Review with proper message
        window.requestReview = (orderId) => {
            const order = window.orders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                return;
            }
            
            const message = `Hello ${order.customer.name}! üëã

Thank you for trusting Mr Boot with your shoes! 

We hope you're happy with our service. Would you mind sharing your experience?

‚≠ê Please leave us a Google review:
${REVIEW_LINK}

Your feedback helps us improve and helps others discover our service! üôè

- Team Mr Boot
üìû +91 9028983659`;
            
            if (confirm("Send review request to customer via WhatsApp?")) {
                const whatsappNumber = order.customer.whatsapp || order.customer.phone;
                sendAutoWhatsApp(whatsappNumber, message);
            }
        };

        // --- Loader ---
        const showLoading = (msg) => {
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.remove('hidden');
        };
        const hideLoading = () => document.getElementById('loading-overlay').classList.add('hidden');
        
        // Network Check
        const updateNetworkStatus = () => {
             const status = document.getElementById('net-status');
             if(status) status.innerText = navigator.onLine ? "Online" : "Offline";
        };
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        // --- Auth ---
        window.loginWithEmail = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if(!email || !pass) return alert("Enter Email and Password");
            showLoading("Logging in...");
            try { 
                await auth.signInWithEmailAndPassword(email, pass);
            } 
            catch(e) { 
                hideLoading();
                alert("Login failed: " + e.message); 
            }
        };

        window.registerWithEmail = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            if(!email || !pass) return alert("Enter Email and Password to create account");
            showLoading("Creating Account...");
            try {
                await auth.createUserWithEmailAndPassword(email, pass);
                alert("Account Created! You are now logged in.");
            } catch(e) {
                hideLoading();
                alert("Registration failed: " + e.message);
            }
        };

        window.logout = () => auth.signOut();
        
        window.testConnection = async () => {
            showLoading("Testing Write Access...");
            try {
                const docRef = await db.collection("test_connection").add({
                    test: true,
                    timestamp: Date.now()
                });
                await db.collection("test_connection").doc(docRef.id).delete();
                hideLoading();
                alert("Connection Successful! Database is Writable.");
            } catch(e) {
                hideLoading();
                alert("Connection Failed: " + e.message + "\n\nCHECK FIREBASE RULES.");
            }
        };

        auth.onAuthStateChanged(user => { 
            console.log('üîÑ Auth state changed:', user ? user.email : 'No user');
            if(user) { 
                console.log('‚úÖ User logged in:', user.email);
                document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('db-status').style.background = '#34C759'; 
                document.getElementById('user-email-display').innerText = user.email;
                if(document.getElementById('sync-status')) document.getElementById('sync-status').innerText = "Logged In";
                updateNetworkStatus();
                hideLoading();
                
                const loadTimeout = setTimeout(() => {
                    console.log('‚è∞ Load timeout reached');
                    hideLoading();
                }, 10000); 
                
                console.log('üì° Initializing listeners...');
                initListeners(() => {
                    console.log('‚úÖ Listeners initialized');
                    clearTimeout(loadTimeout);
                    
                    // Check reminders after data loads
                    setTimeout(() => {
                        console.log('üîî Running initial reminder check');
                        window.checkDueDateReminders();
                    }, 2000);
                    
                    // Check every hour
                    setInterval(() => {
                        console.log('üîî Running hourly reminder check');
                        window.checkDueDateReminders();
                    }, 3600000); // 1 hour
                }); 
            } else {
                console.log('‚ö†Ô∏è No user - showing login screen');
                document.getElementById('login-screen').classList.remove('hidden');
                hideLoading();
            }
        });

        // --- Core ---
        function initListeners(onFirstLoad) {
            let firstLoad = true;
            db.collection("orders").onSnapshot((snap) => {
                window.orders = [];
                snap.forEach(doc => window.orders.push({id: doc.id, ...doc.data()}));
                window.orders.sort((a,b) => b.timestamp - a.timestamp);
                
                window.customers = {};
                window.orders.forEach(o => {
                    const p = o.customer.phone;
                    if(!window.customers[p]) window.customers[p] = { name: o.customer.name, phone: p, count: 0, spend: 0 };
                    window.customers[p].count++;
                    window.customers[p].spend += o.financials.total;
                });
                
                window.renderOrders();
                window.renderReports();
                window.renderCustomers();
                if(viewingOrderId) window.openViewOrder(viewingOrderId);
                
                if(firstLoad && onFirstLoad) { onFirstLoad(); firstLoad = false; }
            }, (error) => {
                hideLoading();
                if(error.code === 'permission-denied') alert("Database Permission Denied. Please enable Test Mode rules in Firebase Console.");
            });

            db.collection("inventory").onSnapshot((snap) => {
                window.inventory = [];
                snap.forEach(doc => window.inventory.push({id: doc.id, ...doc.data()}));
                window.renderInventory();
                window.populateStockDropdown();
            });

            db.collection("gallery").onSnapshot((snap) => {
                window.gallery = [];
                snap.forEach(doc => window.gallery.push({id: doc.id, ...doc.data()}));
                window.renderGallery();
            });
        }

        const compressImage = async (file) => {
            let imageFile = file;
            if (file.name.toLowerCase().endsWith('.heic') || file.type === 'image/heic') {
                if (window.heic2any) {
                    try {
                        const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.6 });
                        imageFile = Array.isArray(blob) ? blob[0] : blob;
                    } catch(e) { console.error("HEIC convert failed", e); }
                }
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(imageFile);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const max = 500; 
                        let w = img.width, h = img.height;
                        if(w>h){ if(w>max){ h*=max/w; w=max; }} else { if(h>max){ w*=max/h; h=max; }}
                        canvas.width=w; canvas.height=h;
                        ctx.drawImage(img,0,0,w,h);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                    img.onerror = () => reject(new Error("Img Error"));
                };
                reader.onerror = reject;
            });
        };

        const uploadImages = async (orderId, files, type, btn) => {
            for (let i = 0; i < files.length; i++) {
                try {
                    if (btn) btn.innerText = `Uploading Photo ${i+1}/${files.length}...`;
                    const base64 = await compressImage(files[i]);
                    // Use STRING ID as link between collections
                    await db.collection("images").add( { orderId: String(orderId), type, blob: base64, timestamp: Date.now() });
                } catch (e) { console.error(e); }
            }
        };

        // Validate image count (max 20)
        window.validateImageCount = (input, maxCount) => {
            if (input.files.length > maxCount) {
                alert(`Maximum ${maxCount} photos allowed! You selected ${input.files.length} photos.`);
                input.value = '';
                return false;
            }
            return true;
        };

        // --- GLOBAL FUNCTIONS ---
        window.saveOrder = async (e) => {
            e.preventDefault();
            
            if (!navigator.onLine) return alert("No Internet Connection");
            if (!auth.currentUser) return alert("Not logged in. Please refresh.");

            const btn = document.getElementById('save-order-btn');
            const items = [];
            document.querySelectorAll('.item-row').forEach(r => {
                const typeSelect = r.querySelector('.item-type');
                const typeOtherInput = r.querySelector('.item-type-other');
                
                // Use custom type if "Other" is selected and text is provided
                let productType = typeSelect.value;
                if(productType === 'Other' && typeOtherInput.value.trim()) {
                    productType = typeOtherInput.value.trim();
                }
                
                items.push({
                    brand: r.querySelector('.item-brand').value,
                    type: productType,
                    service: r.querySelector('.item-service').value,
                    specs: r.querySelector('.item-specs').value,
                    price: parseFloat(r.querySelector('.item-price').value)||0
                });
            });
            if(!items.length) return alert("Add Items");

            const timeout = setTimeout(() => {
                btn.disabled = false; btn.innerText = "Save Order";
                hideLoading();
                alert("Request timed out (Internet slow). Check connection.");
            }, 20000);

            btn.disabled = true; btn.innerText = "Saving Data...";
            
            try {
                let maxSeq = 0;
                window.orders.forEach(o => { const s = parseInt(o.seqId); if(!isNaN(s) && s > maxSeq) maxSeq = s; });
                const seqId = String(maxSeq + 1).padStart(3, '0');
                
                // Safe element getter with null check
                const getElementValue = (id, defaultValue = '') => {
                    const el = document.getElementById(id);
                    if (!el) {
                        console.error(`Element not found: ${id}`);
                        return defaultValue;
                    }
                    return el.value || defaultValue;
                };
                
                const itemTotal = parseFloat(getElementValue('ord-item-total', '0'));
                const deliveryCharge = parseFloat(getElementValue('ord-delivery-charge', '0')) || 0;
                const advance = parseFloat(getElementValue('ord-advance', '0')) || 0;
                
                // Get add-on price if selected
                let addonPrice = 0;
                let addonName = '';
                const stockId = getElementValue('ord-stock-item', '');
                if(stockId) {
                    const stockItem = window.inventory.find(i => i.id === stockId);
                    if(stockItem) {
                        addonPrice = parseFloat(stockItem.price) || 0;
                        addonName = stockItem.name;
                    }
                }
                
                const finalTotal = itemTotal + deliveryCharge + addonPrice;
                
                // Get custom order date or use today
                const customDate = getElementValue('ord-date-created');
                let orderDate, orderTimestamp;
                
                if(customDate) {
                    // User specified a custom date (for backdating)
                    const selectedDate = new Date(customDate);
                    orderDate = selectedDate.toLocaleDateString();
                    orderTimestamp = selectedDate.getTime();
                } else {
                    // Use today's date
                    orderDate = new Date().toLocaleDateString();
                    orderTimestamp = Date.now();
                }
                
                const orderData = {
                    seqId, 
                    timestamp: orderTimestamp,
                    date: orderDate,
                    deliveryDate: getElementValue('ord-date-delivery'),
                    customer: { 
                        name: getElementValue('ord-name'), 
                        phone: getElementValue('ord-phone'),
                        whatsapp: getElementValue('ord-whatsapp') || getElementValue('ord-phone'),
                        address: getElementValue('ord-address')
                    },
                    items,
                    delivery: { 
                        mode: getElementValue('ord-delivery-mode', 'Pickup'), 
                        porterCost: parseFloat(getElementValue('ord-porter-cost', '0')) || 0, 
                        charge: deliveryCharge 
                    },
                    financials: { 
                        itemTotal, 
                        addonPrice,
                        addonName,
                        deliveryCharge,
                        total: finalTotal, 
                        advance, 
                        balance: finalTotal - advance, 
                        mode: getElementValue('ord-paymode', 'Cash') 
                    },
                    status: 'Pending',
                    stockUsed: stockId || null
                };

                const docRef = await db.collection("orders").add( orderData);
                const newOrderId = docRef.id;

                btn.innerText = "Uploading Photos...";
                const main = document.getElementById('ord-main-image').files[0];
                if(main) await uploadImages(newOrderId, [main], 'main', btn);
                
                const others = document.getElementById('ord-images').files;
                if(others.length) await uploadImages(newOrderId, others, 'intake', btn);

                // Stock - use the stockId already declared above
                if(stockId) {
                    const stockItem = window.inventory.find(i => i.id === stockId);
                    if(stockItem) {
                        const newQty = Math.max(0, stockItem.qty - 1);
                        await db.collection("inventory").doc(stockId).update( { qty: newQty });
                    }
                }

                clearTimeout(timeout);
                window.closeModal('modal-order');
                window.switchView('orders');
                
                // AUTO-SEND BILL VIA WHATSAPP
                setTimeout(() => {
                    window.autoSendBillAfterCreation(newOrderId);
                }, 1000); 

            } catch(e) {
                clearTimeout(timeout);
                alert("Error Saving: " + e.message);
                console.error(e);
            } finally {
                btn.disabled = false; btn.innerText = "Save Order";
                hideLoading();
            }
        };

        window.renderOrders = (filter = 'All') => {
            const list = document.getElementById('orders-list');
            list.innerHTML = '';
            
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            
            const filtered = window.orders.filter(o => {
                const matchesFilter = filter === 'All' || o.status === filter;
                const matchesSearch = o.seqId.toLowerCase().includes(searchTerm) || 
                                      o.customer.name.toLowerCase().includes(searchTerm) || 
                                      o.customer.phone.includes(searchTerm);
                return matchesFilter && matchesSearch;
            });
            
            // SORT IN DESCENDING ORDER (newest first)
            filtered.sort((a, b) => {
                // Sort by timestamp descending (newest first)
                return (b.timestamp || 0) - (a.timestamp || 0);
            });
            
            const today = new Date().toISOString().split('T')[0];
            const due = window.orders.filter(o => o.deliveryDate === today && o.status !== 'Completed').length;
            const alert = document.getElementById('delivery-alert');
            if(due > 0) { alert.classList.remove('hidden'); document.getElementById('delivery-count').innerText = due; } else alert.classList.add('hidden');

            filtered.forEach(o => {
                const isSelected = window.selectedOrders.has(o.id);
                const div = document.createElement('div');
                div.className = `card ${window.isSelectMode && isSelected ? 'selecting' : ''}`;
                
                div.onclick = () => {
                    if (window.isSelectMode) window.toggleOrderSelection(o.id);
                    else window.openViewOrder(o.id);
                };

                const itemsText = o.items ? o.items.map(i=>i.type).join(', ') : '';
                const checkUI = window.isSelectMode ? `<div class="checkbox-overlay">${isSelected ? '' : ''}</div>` : '';
                
                div.innerHTML = `<div style="display:flex; align-items:center;">${checkUI}<div style="flex:1;"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span class="badge" style="background:#eee;">#${o.seqId}</span><span style="font-size:12px; color:#888;">${o.date}</span></div><div style="font-weight:bold; font-size:16px;">${o.customer.name}</div><div style="font-size:14px; color:#555; margin:4px 0;">${itemsText}</div><div style="display:flex; justify-content:space-between; margin-top:8px;"><span class="badge ${o.status==='Completed'?'bg-completed':(o.status==='Ready'?'bg-ready':'bg-pending')}">${o.status}</span><span style="font-weight:bold; color:${o.financials.balance>0?'var(--danger)':'var(--success)'}">Bal: ${o.financials.balance}</span></div></div></div>`;
                list.appendChild(div);
            });
        };

        window.openViewOrder = (id) => {
            viewingOrderId = id;
            const o = window.orders.find(x => x.id === id);
            if(!o) return;
            const content = document.getElementById('view-order-content');
            const actions = document.getElementById('order-action-bar');
            let itemsHtml = o.items.map(i => `<div style="border-bottom:1px solid #eee; padding:8px 0;"><b>${i.brand} ${i.type}</b><br><small>${i.service}</small></div>`).join('');
            
            // Add add-on display if present
            let addonHtml = '';
            if(o.financials.addonPrice && o.financials.addonPrice > 0) {
                addonHtml = `<div style="background:#E5F1FF; padding:10px; border-radius:8px; margin-top:10px;"><b style="color:#007AFF;">Add-on: ${o.financials.addonName || 'Item'}</b><br><small>‚Çπ${o.financials.addonPrice}</small></div>`;
            }
            
            content.innerHTML = `<div style="text-align:center; margin-bottom:16px;"><div id="view-order-main-photo" style="width:100%; height:200px; background:#f0f0f0; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; overflow:hidden;">Loading Photo...</div><h2>${o.customer.name}</h2><a href="tel:${o.customer.phone}" style="color:var(--info);">${o.customer.phone}</a></div><div class="card" style="background:#fafafa;">${itemsHtml}${addonHtml}</div><div style="display:flex; justify-content:space-between; margin-top:16px;"><span>Total: <b>‚Çπ${o.financials.total}</b></span><span>Balance: <b style="color:${o.financials.balance>0?'red':'green'}">‚Çπ${o.financials.balance}</b></span></div><div id="view-order-intake-images" class="img-grid" style="margin-top:16px;"></div>${o.status === 'Completed' ? `<h4 style="margin-top:10px; color:green;">Proof</h4><div id="view-order-proof-images" class="img-grid"></div>` : ''}`;

            // Load Images (Cloud) - Using STRING ID match
            const q = db.collection("images").where("orderId", "==", String(id));
            q.get().then(snap => {
                 const mainC = document.getElementById('view-order-main-photo');
                 const intakeC = document.getElementById('view-order-intake-images');
                 const proofC = document.getElementById('view-order-proof-images');
                 if(intakeC) intakeC.innerHTML = '';
                 if(proofC) proofC.innerHTML = '';
                 let mainFound = false;
                 snap.forEach(doc => {
                     const d = doc.data();
                     const img = `<img src="${d.blob}" class="img-thumb" onclick="window.openImageModal('${d.blob}')">`;
                     if(d.type === 'main') { mainC.innerHTML = `<img src="${d.blob}" style="width:100%; height:100%; object-fit:cover;" onclick="window.openImageModal('${d.blob}')">`; mainFound=true; }
                     else if (d.type === 'intake' && intakeC) intakeC.innerHTML += img;
                     else if (d.type === 'proof' && proofC) proofC.innerHTML += img;
                 });
                 if(!mainFound) mainC.innerHTML = '<span style="color:#999;font-size:12px;">No Cover Photo</span>';
            });

            actions.innerHTML = '';
            if(o.status === 'Pending') {
                actions.innerHTML = `<button class="btn btn-whatsapp" onclick="window.shareBill('${o.id}')">Send Bill</button><button class="btn btn-primary" onclick="window.updateStatus('${o.id}', 'Ready')">Mark Ready</button>`;
            } else if (o.status === 'Ready') {
                const whatsappNum = o.customer.whatsapp || o.customer.phone;
                actions.innerHTML = `
                    <button class="btn btn-whatsapp" onclick="window.sendWhatsApp('${whatsappNum}', 'Hello ${o.customer.name}, your order #${o.seqId} is ready!')">Notify</button>
                    <button class="btn btn-primary" onclick="window.initiateCompleteOrder('${o.id}')">Complete</button>
                    <button class="btn" onclick="window.undoStatus('${o.id}', 'Pending')" style="background:#FF9500; color:white; border:none; margin-left:auto; padding:10px 16px; font-size:14px;">‚Ü©Ô∏è Undo to Pending</button>
                `;
            } else {
                actions.innerHTML = `
                    <button class="btn btn-whatsapp" onclick="window.requestReview('${o.id}')">‚≠ê Ask Review</button>
                    <button class="btn" onclick="window.createBeforeAfterComparison('${o.id}')" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; padding:10px 16px; font-size:14px;">üì∏ Before/After</button>
                    <button class="btn" onclick="window.undoStatus('${o.id}', 'Ready')" style="background:#FF9500; color:white; border:none; margin-left:auto; padding:10px 16px; font-size:14px;">‚Ü©Ô∏è Undo to Ready</button>
                `;
            }
            document.getElementById('modal-view-order').classList.add('open');
        };

        window.updateStatus = async (id, status) => {
            const updates = { status };
            if(status === 'Completed') updates['financials.balance'] = 0;
            try {
                await db.collection("orders").doc(id).update( updates);
                if(status !== 'Completed') window.closeModal('modal-view-order');
                
                // AUTO-NOTIFY CUSTOMER WHEN READY
                if(status === 'Ready') {
                    setTimeout(() => {
                        window.notifyCustomerOrderReady(id);
                    }, 500);
                }
            } catch(e) { alert("Error updating: " + e.message); }
        };
        
        // UNDO STATUS - Move back to previous status
        window.undoStatus = async (id, newStatus) => {
            const order = window.orders.find(o => o.id === id);
            if (!order) return;
            
            const currentStatus = order.status;
            const statusNames = {
                'Pending': 'Pending',
                'Ready': 'Ready',
                'Completed': 'Completed'
            };
            
            const confirmMessage = `Are you sure you want to change status?\n\n${statusNames[currentStatus]} ‚Üí ${statusNames[newStatus]}\n\nOrder #${order.seqId} - ${order.customer.name}`;
            
            if(!confirm(confirmMessage)) return;
            
            try {
                const updates = { status: newStatus };
                
                // If moving back from Completed, restore the balance
                if(currentStatus === 'Completed' && newStatus !== 'Completed') {
                    const originalBalance = order.financials.total - order.financials.advance;
                    updates['financials.balance'] = originalBalance;
                }
                
                await db.collection("orders").doc(id).update(updates);
                window.closeModal('modal-view-order');
                
                alert(`‚úÖ Status changed back to ${statusNames[newStatus]}!`);
            } catch(e) {
                alert("Error undoing status: " + e.message);
            }
        };

        window.initiateCompleteOrder = (id) => {
            pendingCompleteId = id; document.getElementById('modal-proof').classList.add('open');
        }

        window.saveProofAndComplete = async () => {
            const files = document.getElementById('proof-image').files;
            if(!files.length) return alert("Upload Proof");
            const btn = document.querySelector('#modal-proof .btn-primary');
            btn.disabled = true; btn.innerText = "Uploading...";
            try {
                await uploadImages(pendingCompleteId, files, 'proof', null);
                await window.updateStatus(pendingCompleteId, 'Completed');
                window.closeModal('modal-proof');
            } catch(e) { alert("Error: " + e.message); }
            finally { btn.disabled = false; btn.innerText = "Complete"; }
        };

        window.deleteOrder = async () => {
            if(!confirm("Delete permanently?")) return;
            try {
                await db.collection("orders").doc(viewingOrderId).delete();
                window.closeModal('modal-view-order');
            } catch(e) { alert("Error deleting: " + e.message); }
        }
        
        window.deleteInventoryItem = async (id) => {
            if(!confirm("Delete this inventory item?")) return;
            try {
                await db.collection("inventory").doc(id).delete();
            } catch(e) { alert("Error deleting: " + e.message); }
        };

        // --- GALLERY FUNCTIONS ---
        window.saveGalleryItem = async () => {
            const caption = document.getElementById('gal-caption').value;
            const file = document.getElementById('gal-image').files[0];
            if(!file) return alert("Select Image");
            showLoading("Uploading to Gallery...");
            try {
                const base64 = await compressImage(file);
                await db.collection("gallery").add( { caption, blob: base64, timestamp: Date.now() });
                window.closeModal('modal-gallery-upload');
            } catch(e) { alert("Error: " + e.message); }
            finally { hideLoading(); }
        };

        window.renderGallery = () => {
            const el = document.getElementById('gallery-list');
            el.innerHTML = window.gallery.map(i => `
                <div class="gallery-item" onclick="window.openImageModal('${i.blob}')">
                    <img src="${i.blob}">
                    <div class="gallery-caption">${i.caption || 'Work'}</div>
                    <button class="gallery-delete" onclick="event.stopPropagation(); window.deleteGalleryItem('${i.id}')">√ó</button>
                </div>
            `).join('');
        };
        
        window.deleteGalleryItem = async (id) => {
            if(!confirm("Remove from gallery?")) return;
            await db.collection("gallery").doc(id).delete();
        };

        window.switchView = (id, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'orders') window.renderOrders(); if(id === 'customers') window.renderCustomers(); if(id === 'inventory') window.renderInventory(); 
            if(id === 'reports') window.renderReports(); if(id === 'gallery') window.renderGallery();
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.openOrderModal = () => { document.getElementById('order-form').reset(); document.getElementById('order-items-container').innerHTML = ''; window.addOrderItem(); document.getElementById('modal-order').classList.add('open'); }
        window.addOrderItem = () => {
            const div = document.createElement('div'); div.className = 'item-row';
            div.innerHTML = `<button type="button" class="remove-item" onclick="this.parentElement.remove(); window.calcBalance();">&times;</button><div class="flex-row"><input type="text" class="item-brand" placeholder="Brand"><select class="item-type" onchange="window.handleProductTypeChange(this)"><option>Sneaker</option><option>Sport Shoe</option><option>Formal Shoe</option><option>Boots</option><option>Heels</option><option>Sandals</option><option>Loafers</option><option>Slippers</option><option>Bags</option><option>Handbag</option><option>Backpack</option><option>Jacket</option><option>Leather Jacket</option><option>Suede Shoes</option><option>Canvas Shoes</option><option>Running Shoes</option><option>Trekking Shoes</option><option>School Shoes</option><option>Safety Shoes</option><option>Other</option></select><input type="text" class="item-type-other" placeholder="Specify product type" style="display:none; margin-top:5px;"></div><input type="text" class="item-service" placeholder="Select Services" readonly onclick="window.openServiceSelector(this)" style="cursor:pointer; background:white;"><div class="flex-row"><input type="text" class="item-specs" placeholder="Specs"><input type="number" class="item-price" placeholder="Price" oninput="window.calcBalance()"></div>`;
            document.getElementById('order-items-container').appendChild(div);
        }
        
        // Handle "Other" selection for product type
        window.handleProductTypeChange = (selectEl) => {
            const itemRow = selectEl.closest('.item-row');
            const otherInput = itemRow.querySelector('.item-type-other');
            
            if(selectEl.value === 'Other') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        };
        window.openServiceSelector = (el) => {
            currentServiceInput = el; 
            const container = document.getElementById('service-options-container'); 
            container.innerHTML = ''; 
            const current = el.value.split(', ').filter(v => v);
            
            // Check if there's a custom "Other" value
            const otherBox = document.getElementById('other-service-box');
            const otherInput = document.getElementById('other-service-input');
            const hasOther = current.find(s => !ALL_SERVICES.includes(s));
            
            if(hasOther) {
                otherInput.value = hasOther;
                otherBox.style.display = 'block';
            } else {
                otherInput.value = '';
                otherBox.style.display = 'none';
            }
            
            ALL_SERVICES.forEach(s => { 
                const isChecked = s === 'Other' ? hasOther || current.includes('Other') : current.includes(s);
                container.innerHTML += `<label class="service-option-label"><input type="checkbox" value="${s}" ${isChecked?'checked':''} onchange="window.handleServiceCheckbox(this)"><span class="service-text">${s}</span><div class="service-tick"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div></label>`; 
            });
            
            document.getElementById('modal-service-selector').classList.add('open');
        };
        
        // Handle checkbox changes, especially for "Other"
        window.handleServiceCheckbox = (checkbox) => {
            const otherBox = document.getElementById('other-service-box');
            const otherInput = document.getElementById('other-service-input');
            
            if(checkbox.value === 'Other') {
                if(checkbox.checked) {
                    otherBox.style.display = 'block';
                    otherInput.focus();
                } else {
                    otherBox.style.display = 'none';
                    otherInput.value = '';
                }
            }
        };
        
        window.saveServiceSelection = () => {
            const checkboxes = document.querySelectorAll('#service-options-container input:checked');
            const vals = [];
            const otherInput = document.getElementById('other-service-input');
            
            checkboxes.forEach(c => {
                if(c.value === 'Other') {
                    // If "Other" is checked and there's custom text, use that
                    const customService = otherInput.value.trim();
                    if(customService) {
                        vals.push(customService);
                    } else {
                        vals.push('Other');
                    }
                } else {
                    vals.push(c.value);
                }
            });
            
            if(currentServiceInput) currentServiceInput.value = vals.join(', '); 
            window.closeModal('modal-service-selector');
        };
        window.calcBalance = () => {
            let total = 0; 
            document.querySelectorAll('.item-price').forEach(i => total += (parseFloat(i.value)||0));
            
            const itemTotalEl = document.getElementById('ord-item-total');
            if(itemTotalEl) itemTotalEl.value = total;
            
            const delEl = document.getElementById('ord-delivery-charge');
            const advEl = document.getElementById('ord-advance');
            const del = delEl ? (parseFloat(delEl.value)||0) : 0; 
            const adv = advEl ? (parseFloat(advEl.value)||0) : 0;
            
            // Add add-on price
            let addonPrice = 0;
            const stockEl = document.getElementById('ord-stock-item');
            if(stockEl) {
                const stockId = stockEl.value;
                if(stockId) {
                    const stockItem = window.inventory.find(i => i.id === stockId);
                    if(stockItem) {
                        addonPrice = parseFloat(stockItem.price) || 0;
                    }
                }
            }
            
            const balanceEl = document.getElementById('ord-balance');
            if(balanceEl) balanceEl.innerText = (total + del + addonPrice - adv);
        }
        window.toggleDeliveryFields = () => {
            const modeEl = document.getElementById('ord-delivery-mode');
            const fieldsEl = document.getElementById('delivery-fields');
            if(modeEl && fieldsEl) {
                fieldsEl.style.display = modeEl.value === 'Pickup' ? 'block' : 'none';
            }
        }
        window.openInventoryModal = () => document.getElementById('modal-inventory').classList.add('open');
        window.saveInventory = async (e) => {
            e.preventDefault();
            try {
                await db.collection("inventory").add( { name: document.getElementById('inv-name').value, brand: document.getElementById('inv-brand').value, qty: document.getElementById('inv-qty').value, price: document.getElementById('inv-price').value }); 
                window.closeModal('modal-inventory');
            } catch(e) { alert("Error: " + e.message); }
        }
        window.renderInventory = () => {
            const el = document.getElementById('inventory-list'); el.innerHTML = window.inventory.map(i => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="font-weight:600;">${i.name}</span>
                        <br><span style="font-size:12px; color:#888;">${i.brand || ''}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="text-align:right;">
                            <b>Qty: ${i.qty}</b><br>
                            <span style="font-size:12px;">‚Çπ${i.price}</span>
                        </div>
                        <button onclick="window.deleteInventoryItem('${i.id}')" style="background:none; border:none; color:#FF3B30; font-size:20px; padding:0; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        window.populateStockDropdown = () => {
            const s = document.getElementById('ord-stock-item');
            s.innerHTML = '<option value="">-- Select --</option>'; window.inventory.forEach(i => s.innerHTML+=`<option value="${i.id}">${i.name}</option>`);
        }
        window.updateStockLabel = () => {}; 
        window.filterOrders = (status) => {
            document.querySelectorAll('.badge').forEach(b => b.style.opacity='0.5'); event.target.style.opacity='1'; window.renderOrders(status);
        }
        window.sendWhatsApp = (phone, text) => window.open(`https://wa.me/91${phone.replace(/\D/g, '')}?text=${encodeURIComponent(text)}`, '_blank');
        window.openImageModal = (src) => { document.getElementById('preview-full-img').src=src; document.getElementById('modal-image-preview').classList.add('open'); };
        window.backupData = () => alert("Online mode is active. Data is already in cloud.");
        window.restoreData = () => alert("Online mode is active. Data is pulled from cloud.");

        window.renderReports = () => {
            let rev=0, pend=0, prof=0;
            window.orders.forEach(o => { 
                rev+=o.financials.total; 
                if(o.status!=='Completed') pend+=o.financials.balance; 
                if(o.delivery && o.delivery.porterCost) prof -= o.delivery.porterCost;
            });
            prof += rev;
            document.getElementById('rep-revenue').innerText = rev;
            document.getElementById('rep-pending').innerText = pend;
            document.getElementById('rep-profit').innerText = prof;
            
            // Render daily revenue calendar
            window.renderDailyRevenue();
            
            // Render advanced analytics
            if (typeof window.renderAdvancedAnalytics === 'function') {
                window.renderAdvancedAnalytics();
            }
        };
        
        window.renderDailyRevenue = () => {
            const container = document.getElementById('daily-revenue-container');
            if (!container) return;
            
            // Get last 7 days
            const dailyData = {};
            const today = new Date();
            
            // Initialize last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                dailyData[dateStr] = { total: 0, earned: 0, orders: 0 };
            }
            
            // Calculate revenue per day
            window.orders.forEach(o => {
                const orderDate = new Date(o.timestamp);
                const dateStr = orderDate.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                
                if (dailyData[dateStr]) {
                    dailyData[dateStr].total += o.financials.total || 0;
                    dailyData[dateStr].orders++;
                    
                    if (o.status === 'Completed') {
                        dailyData[dateStr].earned += o.financials.total || 0;
                    }
                }
            });
            
            // Render as table
            let html = '<table style="width:100%; font-size:13px; border-collapse:collapse;">';
            html += '<thead><tr style="border-bottom:2px solid #ddd; text-align:left;">';
            html += '<th style="padding:8px;">Date</th>';
            html += '<th style="padding:8px; text-align:center;">Orders</th>';
            html += '<th style="padding:8px; text-align:right;">Budget</th>';
            html += '<th style="padding:8px; text-align:right;">Earned</th>';
            html += '</tr></thead><tbody>';
            
            Object.entries(dailyData).forEach(([date, data]) => {
                const isToday = date === today.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                const rowStyle = isToday ? 'background:#E3F2FD; font-weight:bold;' : '';
                
                html += `<tr style="${rowStyle} border-bottom:1px solid #eee;">`;
                html += `<td style="padding:8px;">${date}${isToday ? ' üìç' : ''}</td>`;
                html += `<td style="padding:8px; text-align:center;">${data.orders}</td>`;
                html += `<td style="padding:8px; text-align:right; color:#FF9500;">‚Çπ${data.total}</td>`;
                html += `<td style="padding:8px; text-align:right; color:#4CAF50; font-weight:bold;">‚Çπ${data.earned}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        };

        window.renderCustomers = () => {
            const el = document.getElementById('customers-list'); el.innerHTML = '';
            
            // Search Logic
            const term = document.getElementById('customer-search').value.toLowerCase();
            const filteredCust = Object.values(window.customers).filter(c => 
                c.name.toLowerCase().includes(term) || c.phone.includes(term)
            );

            filteredCust.forEach(c => { 
                const safePhone = c.phone.replace("'", "\\'");
                el.innerHTML += `<div class="card" onclick="window.showHistory('${safePhone}')"><h3>${c.name}</h3><p>${c.phone}</p><p>Orders: ${c.count}</p></div>`; 
            });
        };
        
        window.showHistory = (phone) => {
            const list = window.orders.filter(o => o.customer.phone === phone);
            const el = document.getElementById('customer-history-content');
            el.innerHTML = '';
            list.forEach(o => {
                 let itemText = o.items ? o.items.map(i => i.brand).join(", ") : (o.details ? o.details.type : "");
                 const div = document.createElement('div');
                 div.className = 'card';
                 div.innerHTML = `
                    <div style="font-weight:bold; display:flex; justify-content:space-between;">
                        <span>Order #${o.seqId}</span>
                        <span style="font-size:12px; color:#888;">${o.date}</span>
                    </div>
                    <p style="margin:4px 0 8px 0; font-size:14px;">${itemText}</p>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <span style="font-size:10px; text-transform:uppercase; color:#666;">Before</span>
                            <div id="hist-intake-${o.id}" class="img-grid" style="height:50px;"></div>
                        </div>
                        <div style="flex:1;">
                            <span style="font-size:10px; text-transform:uppercase; color:#34C759;">After</span>
                            <div id="hist-proof-${o.id}" class="img-grid" style="height:50px;"></div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="window.viewHistoricalBill('${o.id}')" style="margin:0; padding:8px; font-size:12px;">üìÑ View Bill</button>
                 `;
                 el.appendChild(div);
                 
                 // Fetch images for history
                 const q = db.collection("images").where("orderId", "==", o.id);
                 q.get().then(snap => {
                     const inC = document.getElementById(`hist-intake-${o.id}`);
                     const prC = document.getElementById(`hist-proof-${o.id}`);
                     snap.forEach(doc => {
                         const d = doc.data();
                         const img = `<img src="${d.blob}" class="img-thumb" onclick="window.openImageModal('${d.blob}')">`;
                         if(d.type === 'intake' && inC) inC.innerHTML += img;
                         if(d.type === 'main' && inC) inC.innerHTML += img;
                         if(d.type === 'proof' && prC) prC.innerHTML += img;
                     });
                 });
            });
            document.getElementById('modal-customer-history').classList.add('open');
        }
        
        // View historical bill
        window.viewHistoricalBill = async (orderId) => {
            await window.shareBill(orderId);
        };
        
        // Edit Order Functions
        let currentEditOrderId = null;
        
        window.editOrder = () => {
            if (!viewingOrderId) return;
            
            const o = window.orders.find(x => x.id === viewingOrderId);
            if (!o) return;
            
            currentEditOrderId = viewingOrderId;
            
            // Populate form
            document.getElementById('edit-ord-phone').value = o.customer.phone;
            document.getElementById('edit-ord-whatsapp').value = o.customer.whatsapp || '';
            document.getElementById('edit-ord-name').value = o.customer.name;
            document.getElementById('edit-ord-address').value = o.customer.address || '';
            document.getElementById('edit-ord-date-delivery').value = o.deliveryDate || '';
            document.getElementById('edit-ord-status').value = o.status;
            document.getElementById('edit-ord-advance').value = o.financials.advance;
            document.getElementById('edit-ord-paymode').value = o.financials.mode || 'Cash';
            
            // Populate items
            const container = document.getElementById('edit-order-items-container');
            container.innerHTML = '';
            if (o.items && o.items.length > 0) {
                o.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item-row';
                    div.innerHTML = `
                        <button type="button" class="remove-item" onclick="this.parentElement.remove(); window.calcEditBalance();">&times;</button>
                        <div class="flex-row">
                            <input type="text" class="edit-item-brand" placeholder="Brand" value="${item.brand || ''}">
                            <select class="edit-item-type" onchange="window.handleEditProductTypeChange(this)">
                                <option ${item.type === 'Sneaker' ? 'selected' : ''}>Sneaker</option>
                                <option ${item.type === 'Sport Shoe' ? 'selected' : ''}>Sport Shoe</option>
                                <option ${item.type === 'Formal Shoe' ? 'selected' : ''}>Formal Shoe</option>
                                <option ${item.type === 'Boots' ? 'selected' : ''}>Boots</option>
                                <option ${item.type === 'Heels' ? 'selected' : ''}>Heels</option>
                                <option ${item.type === 'Sandals' ? 'selected' : ''}>Sandals</option>
                                <option ${item.type === 'Loafers' ? 'selected' : ''}>Loafers</option>
                                <option ${item.type === 'Slippers' ? 'selected' : ''}>Slippers</option>
                                <option ${item.type === 'Bags' ? 'selected' : ''}>Bags</option>
                                <option ${item.type === 'Handbag' ? 'selected' : ''}>Handbag</option>
                                <option ${item.type === 'Backpack' ? 'selected' : ''}>Backpack</option>
                                <option ${item.type === 'Jacket' ? 'selected' : ''}>Jacket</option>
                                <option ${item.type === 'Leather Jacket' ? 'selected' : ''}>Leather Jacket</option>
                                <option ${item.type === 'Suede Shoes' ? 'selected' : ''}>Suede Shoes</option>
                                <option ${item.type === 'Canvas Shoes' ? 'selected' : ''}>Canvas Shoes</option>
                                <option ${item.type === 'Running Shoes' ? 'selected' : ''}>Running Shoes</option>
                                <option ${item.type === 'Trekking Shoes' ? 'selected' : ''}>Trekking Shoes</option>
                                <option ${item.type === 'School Shoes' ? 'selected' : ''}>School Shoes</option>
                                <option ${item.type === 'Safety Shoes' ? 'selected' : ''}>Safety Shoes</option>
                                <option ${item.type === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                            <input type="text" class="edit-item-type-other" placeholder="Specify product type" style="display:none; margin-top:5px;" value="${item.type === 'Other' || !['Sneaker','Sport Shoe','Formal Shoe','Boots','Heels','Sandals','Loafers','Slippers','Bags','Handbag','Backpack','Jacket','Leather Jacket','Suede Shoes','Canvas Shoes','Running Shoes','Trekking Shoes','School Shoes','Safety Shoes'].includes(item.type) ? item.type : ''}">
                        </div>
                        <input type="text" class="edit-item-service" placeholder="Select Services" readonly onclick="window.openEditServiceSelector(this)" style="cursor:pointer; background:white;" value="${item.service || ''}">
                        <div class="flex-row">
                            <input type="text" class="edit-item-specs" placeholder="Specs" value="${item.specs || ''}">
                            <input type="number" class="edit-item-price" placeholder="Price" oninput="window.calcEditBalance()" value="${item.price || 0}">
                        </div>
                    `;
                    container.appendChild(div);
                });
            } else {
                window.addEditOrderItem();
            }
            
            window.calcEditBalance();
            window.closeModal('modal-view-order');
            document.getElementById('modal-edit-order').classList.add('open');
        };
        
        window.addEditOrderItem = () => {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <button type="button" class="remove-item" onclick="this.parentElement.remove(); window.calcEditBalance();">&times;</button>
                <div class="flex-row">
                    <input type="text" class="edit-item-brand" placeholder="Brand">
                    <select class="edit-item-type" onchange="window.handleEditProductTypeChange(this)">
                        <option>Sneaker</option>
                        <option>Sport Shoe</option>
                        <option>Formal Shoe</option>
                        <option>Boots</option>
                        <option>Heels</option>
                        <option>Sandals</option>
                        <option>Loafers</option>
                        <option>Slippers</option>
                        <option>Bags</option>
                        <option>Handbag</option>
                        <option>Backpack</option>
                        <option>Jacket</option>
                        <option>Leather Jacket</option>
                        <option>Suede Shoes</option>
                        <option>Canvas Shoes</option>
                        <option>Running Shoes</option>
                        <option>Trekking Shoes</option>
                        <option>School Shoes</option>
                        <option>Safety Shoes</option>
                        <option>Other</option>
                    </select>
                    <input type="text" class="edit-item-type-other" placeholder="Specify product type" style="display:none; margin-top:5px;">
                </div>
                <input type="text" class="edit-item-service" placeholder="Select Services" readonly onclick="window.openEditServiceSelector(this)" style="cursor:pointer; background:white;">
                <div class="flex-row">
                    <input type="text" class="edit-item-specs" placeholder="Specs">
                    <input type="number" class="edit-item-price" placeholder="Price" oninput="window.calcEditBalance()">
                </div>
            `;
            document.getElementById('edit-order-items-container').appendChild(div);
        };
        
        // Handle "Other" selection for edit product type
        window.handleEditProductTypeChange = (selectEl) => {
            const itemRow = selectEl.closest('.item-row');
            const otherInput = itemRow.querySelector('.edit-item-type-other');
            
            if(selectEl.value === 'Other') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        };
        
        window.openEditServiceSelector = (el) => {
            currentServiceInput = el;
            const container = document.getElementById('service-options-container');
            container.innerHTML = '';
            const current = el.value.split(', ').filter(s => s);
            ALL_SERVICES.forEach(s => {
                container.innerHTML += `<label class="service-option-label"><input type="checkbox" value="${s}" ${current.includes(s) ? 'checked' : ''}><span class="service-text">${s}</span><div class="service-tick"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div></label>`;
            });
            document.getElementById('modal-service-selector').classList.add('open');
        };
        
        window.calcEditBalance = () => {
            let total = 0;
            document.querySelectorAll('.edit-item-price').forEach(i => total += (parseFloat(i.value) || 0));
            
            const itemTotalEl = document.getElementById('edit-ord-item-total');
            if(itemTotalEl) itemTotalEl.value = total;
            
            const advEl = document.getElementById('edit-ord-advance');
            const adv = advEl ? (parseFloat(advEl.value) || 0) : 0;
            
            const balanceEl = document.getElementById('edit-ord-balance');
            if(balanceEl) balanceEl.innerText = total - adv;
        };
        
        window.saveEditedOrder = async () => {
            if (!currentEditOrderId) return;
            
            try {
                const items = [];
                document.querySelectorAll('#edit-order-items-container .item-row').forEach(r => {
                    const typeSelect = r.querySelector('.edit-item-type');
                    const typeOtherInput = r.querySelector('.edit-item-type-other');
                    
                    // Use custom type if "Other" is selected and text is provided
                    let productType = typeSelect ? typeSelect.value : '';
                    if(productType === 'Other' && typeOtherInput && typeOtherInput.value.trim()) {
                        productType = typeOtherInput.value.trim();
                    }
                    
                    items.push({
                        brand: r.querySelector('.edit-item-brand')?.value || '',
                        type: productType,
                        service: r.querySelector('.edit-item-service')?.value || '',
                        specs: r.querySelector('.edit-item-specs')?.value || '',
                        price: parseFloat(r.querySelector('.edit-item-price')?.value) || 0
                    });
                });
                
                if (!items.length) return alert("Add at least one item");
                
                const getEditValue = (id, defaultValue = '') => {
                    const el = document.getElementById(id);
                    return el ? (el.value || defaultValue) : defaultValue;
                };
                
                const itemTotal = parseFloat(getEditValue('edit-ord-item-total', '0'));
                const advance = parseFloat(getEditValue('edit-ord-advance', '0')) || 0;
                
                const updates = {
                    'customer.name': getEditValue('edit-ord-name'),
                    'customer.phone': getEditValue('edit-ord-phone'),
                    'customer.whatsapp': getEditValue('edit-ord-whatsapp') || getEditValue('edit-ord-phone'),
                    'customer.address': getEditValue('edit-ord-address'),
                    'deliveryDate': getEditValue('edit-ord-date-delivery'),
                    'status': getEditValue('edit-ord-status', 'Pending'),
                    'items': items,
                    'financials.itemTotal': itemTotal,
                    'financials.total': itemTotal,
                    'financials.advance': advance,
                    'financials.balance': itemTotal - advance,
                    'financials.mode': document.getElementById('edit-ord-paymode').value
                };
                
                showLoading('Updating order...');
                
                // Upload new photos if provided
                const mainImgFile = document.getElementById('edit-main-image')?.files[0];
                const additionalFiles = document.getElementById('edit-additional-images')?.files;
                
                if (mainImgFile) {
                    showLoading('Uploading main photo...');
                    const mainUrl = await window.uploadImage(mainImgFile, `orders/${currentEditOrderId}/main`);
                    updates.mainImage = mainUrl;
                }
                
                if (additionalFiles && additionalFiles.length > 0) {
                    showLoading('Uploading additional photos...');
                    const currentOrder = window.orders.find(o => o.id === currentEditOrderId);
                    const existingImages = currentOrder?.intakeImages || [];
                    const newImages = [];
                    
                    for (let i = 0; i < additionalFiles.length; i++) {
                        const url = await window.uploadImage(additionalFiles[i], `orders/${currentEditOrderId}/intake_${Date.now()}_${i}`);
                        newImages.push(url);
                    }
                    
                    // Combine existing and new images (max 20)
                    const allImages = [...existingImages, ...newImages].slice(0, 20);
                    updates.intakeImages = allImages;
                }
                
                await db.collection("orders").doc(currentEditOrderId).update(updates);
                
                hideLoading();
                window.closeModal('modal-edit-order');
                alert("Order updated successfully!");
                
                // Reopen the view modal
                setTimeout(() => window.openViewOrder(currentEditOrderId), 300);
                
            } catch(e) {
                alert("Error updating order: " + e.message);
                console.error(e);
            }
        };

        // ============================================
        // NEW BILL GENERATION (MATCHING IMAGE DESIGN)
        // ============================================
        window.shareBill = async (id) => {
            try {
                const o = window.orders.find(x => x.id === id);
                if (!o) {
                    alert("Order not found!");
                    return;
                }
                
                const canvas = document.getElementById('billCanvas');
                const ctx = canvas.getContext('2d');
                
                // Polyfill for roundRect
                if (!ctx.roundRect) {
                    ctx.roundRect = function(x, y, width, height, radius) {
                        this.beginPath();
                        this.moveTo(x + radius, y);
                        this.lineTo(x + width - radius, y);
                        this.quadraticCurveTo(x + width, y, x + width, y + radius);
                        this.lineTo(x + width, y + height - radius);
                        this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                        this.lineTo(x + radius, y + height);
                        this.quadraticCurveTo(x, y + height, x, y + height - radius);
                        this.lineTo(x, y + radius);
                        this.quadraticCurveTo(x, y, x + radius, y);
                        this.closePath();
                    };
                }
            
            // Calculate dynamic height based on items
            const baseHeight = 1400; // Base height without items
            const itemCount = (o.items ? o.items.length : 0) + (o.financials.addonPrice > 0 ? 1 : 0);
            const itemHeight = 120; // Height per item (with brand/specs)
            const summaryHeight = 450; // Billing summary box
            const footerHeight = 300; // Footer with T&C
            
            // HD Canvas Size (2160px width = 2x for crisp quality)
            const width = 2160;
            const height = baseHeight + (itemCount * itemHeight) + summaryHeight + footerHeight;
            canvas.width = width;
            canvas.height = height;
            
            // Enable high quality image rendering
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // Fill white background
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, width, height);
            
            let y = 80;
            
            // ===== HEADER =====
            ctx.fillStyle = "#000000";
            ctx.font = "bold 56px Arial";
            ctx.textAlign = "left";
            ctx.fillText("Mr Boot Shoe Laundry & Repair", 60, y);
            
            // Logo
            const logoImg = document.getElementById('logo-img-res');
            try {
                if(logoImg.complete && logoImg.naturalWidth > 0) {
                    const logoSize = 120;
                    ctx.drawImage(logoImg, width - logoSize - 60, 40, logoSize, logoSize);
                }
            } catch(e) { console.log("Logo error", e); }
            
            y += 80;
            ctx.font = "48px Arial";
            ctx.fillText("Service Invoice", 60, y);
            
            y += 80;
            ctx.font = "bold 42px Arial";
            ctx.fillText(`Order number: #${o.seqId}`, 60, y);
            
            y += 80;
            
            // ===== INFO BOXES =====
            const boxY = y;
            const boxHeight = 120;
            const boxWidth = (width - 160) / 3;
            
            ctx.fillStyle = "#F5F5F5";
            ctx.fillRect(60, boxY, boxWidth, boxHeight);
            ctx.fillRect(60 + boxWidth + 20, boxY, boxWidth, boxHeight);
            ctx.fillRect(60 + (boxWidth + 20) * 2, boxY, boxWidth, boxHeight);
            
            ctx.strokeStyle = "#DDDDDD";
            ctx.lineWidth = 2;
            ctx.strokeRect(60, boxY, boxWidth, boxHeight);
            ctx.strokeRect(60 + boxWidth + 20, boxY, boxWidth, boxHeight);
            ctx.strokeRect(60 + (boxWidth + 20) * 2, boxY, boxWidth, boxHeight);
            
            ctx.fillStyle = "#000000";
            ctx.font = "28px Arial";
            ctx.textAlign = "center";
            
            // Due Date
            ctx.fillText("Due Date:", 60 + boxWidth/2, boxY + 45);
            ctx.font = "bold 32px Arial";
            ctx.fillText(o.deliveryDate || "N/A", 60 + boxWidth/2, boxY + 85);
            
            // Current Date & Time
            ctx.font = "28px Arial";
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            ctx.fillText("Current Date & Time:", 60 + boxWidth + 20 + boxWidth/2, boxY + 45);
            ctx.font = "bold 32px Arial";
            ctx.fillText(`${dateStr}, ${timeStr}`, 60 + boxWidth + 20 + boxWidth/2, boxY + 85);
            
            // Payment Status
            ctx.font = "28px Arial";
            ctx.fillText("Payment Status:", 60 + (boxWidth + 20) * 2 + boxWidth/2, boxY + 45);
            ctx.font = "bold 32px Arial";
            ctx.fillStyle = o.financials.balance > 0 ? "#FF3B30" : "#34C759";
            ctx.fillText(o.financials.balance > 0 ? "Pending" : "Paid", 60 + (boxWidth + 20) * 2 + boxWidth/2, boxY + 85);
            
            y = boxY + boxHeight + 60;
            
            // ===== MAIN PHOTO =====
            const photoY = y;
            const photoHeight = 500;
            const photoWidth = width - 120;
            
            ctx.fillStyle = "#F5F5F5";
            if (ctx.roundRect) {
                ctx.roundRect(60, photoY, photoWidth, photoHeight, 20);
                ctx.fill();
            } else {
                ctx.fillRect(60, photoY, photoWidth, photoHeight);
            }
            
            // Load photo
            try {
                const q = db.collection("images").where("orderId", "==", String(id));
                const snap = await q.get();
                let mainBlob = null;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.type === 'main') mainBlob = d.blob;
                    else if(d.type === 'intake' && !mainBlob) mainBlob = d.blob;
                });
                
                if(mainBlob) {
                    const imgObj = new Image();
                    imgObj.src = mainBlob;
                    await new Promise(r => imgObj.onload = r);
                    
                    const imgAspect = imgObj.width / imgObj.height;
                    const boxAspect = photoWidth / photoHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    
                    if(imgAspect > boxAspect) {
                        drawWidth = photoWidth - 40;
                        drawHeight = drawWidth / imgAspect;
                        drawX = 60 + 20;
                        drawY = photoY + (photoHeight - drawHeight) / 2;
                    } else {
                        drawHeight = photoHeight - 40;
                        drawWidth = drawHeight * imgAspect;
                        drawX = 60 + (photoWidth - drawWidth) / 2;
                        drawY = photoY + 20;
                    }
                    
                    ctx.save();
                    ctx.beginPath();
                    if (ctx.roundRect) {
                        ctx.roundRect(60, photoY, photoWidth, photoHeight, 20);
                    } else {
                        ctx.rect(60, photoY, photoWidth, photoHeight);
                    }
                    ctx.clip();
                    ctx.drawImage(imgObj, drawX, drawY, drawWidth, drawHeight);
                    ctx.restore();
                }
            } catch(e) {
                console.log("Photo load error", e);
            }
            
            y = photoY + photoHeight + 60;
            
            // ===== SERVICE TABLE =====
            ctx.fillStyle = "#000000";
            ctx.textAlign = "left";
            
            const tableX = 60;
            const colWidths = [450, 150, 150, 200];
            
            ctx.fillStyle = "#F5F5F5";
            ctx.fillRect(tableX, y, width - 120, 60);
            
            ctx.fillStyle = "#000000";
            ctx.font = "bold 32px Arial";
            ctx.fillText("Item / Service Description", tableX + 20, y + 40);
            ctx.fillText("Rate", tableX + colWidths[0], y + 40);
            ctx.fillText("Quantity", tableX + colWidths[0] + colWidths[1], y + 40);
            ctx.textAlign = "right";
            ctx.fillText("Amount", width - 80, y + 40);
            ctx.textAlign = "left";
            
            y += 60;
            
            ctx.strokeStyle = "#DDDDDD";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(tableX, y);
            ctx.lineTo(width - 60, y);
            ctx.stroke();
            
            y += 30;
            
            // ===== ITEMS WITH BRAND/SPECS (Like Image 2) =====
            if(o.items && o.items.length > 0) {
                o.items.forEach(item => {
                    ctx.fillStyle = "#000000";
                    ctx.font = "bold 34px Arial";
                    
                    // Brand + Type (e.g., "Nike Sneaker")
                    const mainText = `${item.brand || ''} ${item.type}`.trim();
                    ctx.fillText(mainText, tableX + 20, y + 35);
                    
                    // Price aligned to right
                    ctx.textAlign = "right";
                    ctx.fillText(`‚Çπ${item.price}`, width - 80, y + 35);
                    ctx.textAlign = "left";
                    
                    y += 50;
                    
                    // Service details (italic, smaller)
                    ctx.font = "italic 28px Arial";
                    ctx.fillStyle = "#666666";
                    ctx.fillText(item.service || '', tableX + 20, y + 20);
                    
                    y += 50;
                    
                    // Specs if present (smaller, gray)
                    if(item.specs && item.specs.trim()) {
                        ctx.font = "26px Arial";
                        ctx.fillStyle = "#888888";
                        ctx.fillText(item.specs, tableX + 20, y + 15);
                        y += 40;
                    }
                    
                    y += 20;
                    
                    // Divider line
                    ctx.strokeStyle = "#EEEEEE";
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(tableX, y);
                    ctx.lineTo(width - 60, y);
                    ctx.stroke();
                    
                    y += 10;
                });
            }
            
            // ===== ADD-ON (if present) =====
            if(o.financials.addonPrice && o.financials.addonPrice > 0) {
                y += 20;
                
                ctx.fillStyle = "#007AFF";
                ctx.font = "bold 34px Arial";
                const addonText = `Add-on: ${o.financials.addonName || 'Item'}`;
                ctx.fillText(addonText, tableX + 20, y + 35);
                
                ctx.textAlign = "right";
                ctx.fillStyle = "#000000";
                ctx.fillText(`‚Çπ${o.financials.addonPrice}`, width - 80, y + 35);
                ctx.textAlign = "left";
                
                y += 60;
                
                ctx.strokeStyle = "#EEEEEE";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(tableX, y);
                ctx.lineTo(width - 60, y);
                ctx.stroke();
                
                y += 10;
            }
            
            y += 60;
            
            // ===== BILLING SUMMARY =====
            const summaryBoxY = y;
            const summaryBoxHeight = 420;
            const summaryBoxWidth = 700; // Increased width to prevent overlap
            const summaryBoxX = width - 60 - summaryBoxWidth;
            
            ctx.fillStyle = "#FFF5F5";
            ctx.strokeStyle = "#FF3B30";
            ctx.lineWidth = 3;
            if (ctx.roundRect) {
                ctx.roundRect(summaryBoxX, summaryBoxY, summaryBoxWidth, summaryBoxHeight, 15);
                ctx.fill();
                ctx.stroke();
            } else {
                ctx.fillRect(summaryBoxX, summaryBoxY, summaryBoxWidth, summaryBoxHeight);
                ctx.strokeRect(summaryBoxX, summaryBoxY, summaryBoxWidth, summaryBoxHeight);
            }
            
            let summaryY = summaryBoxY + 50;
            
            ctx.fillStyle = "#000000";
            ctx.font = "bold 36px Arial";
            ctx.textAlign = "left";
            ctx.fillText("Billing Summary:", summaryBoxX + 30, summaryY);
            
            summaryY += 55;
            ctx.font = "32px Arial";
            
            // Services
            ctx.fillText("Services:", summaryBoxX + 30, summaryY);
            ctx.textAlign = "right";
            ctx.fillText(`‚Çπ${o.financials.itemTotal || o.financials.total}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
            summaryY += 50;
            ctx.textAlign = "left";
            
            // Add-on (if present)
            if(o.financials.addonPrice && o.financials.addonPrice > 0) {
                ctx.fillText(`Add-on (${o.financials.addonName || 'Item'}):`, summaryBoxX + 30, summaryY);
                ctx.textAlign = "right";
                ctx.fillText(`‚Çπ${o.financials.addonPrice}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
                summaryY += 50;
                ctx.textAlign = "left";
            }
            
            // Delivery (if present)
            if(o.financials.deliveryCharge && o.financials.deliveryCharge > 0) {
                ctx.fillText("Delivery:", summaryBoxX + 30, summaryY);
                ctx.textAlign = "right";
                ctx.fillText(`‚Çπ${o.financials.deliveryCharge}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
                summaryY += 50;
                ctx.textAlign = "left";
            }
            
            // Separator
            ctx.strokeStyle = "#DDDDDD";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(summaryBoxX + 30, summaryY);
            ctx.lineTo(summaryBoxX + summaryBoxWidth - 30, summaryY);
            ctx.stroke();
            summaryY += 45;
            
            // Subtotal
            ctx.fillText("Subtotal:", summaryBoxX + 30, summaryY);
            ctx.textAlign = "right";
            ctx.fillText(`‚Çπ${o.financials.total}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
            summaryY += 50;
            ctx.textAlign = "left";
            
            // Advance
            ctx.fillText("Advance Paid:", summaryBoxX + 30, summaryY);
            ctx.textAlign = "right";
            ctx.fillText(`‚Çπ${o.financials.advance}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
            summaryY += 20;
            
            // Separator
            ctx.strokeStyle = "#DDDDDD";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(summaryBoxX + 30, summaryY);
            ctx.lineTo(summaryBoxX + summaryBoxWidth - 30, summaryY);
            ctx.stroke();
            summaryY += 45;
            ctx.textAlign = "left";
            
            // Balance
            ctx.fillText("Balance Amount:", summaryBoxX + 30, summaryY);
            ctx.textAlign = "right";
            ctx.fillStyle = "#FF3B30";
            ctx.font = "bold 38px Arial";
            ctx.fillText(`‚Çπ${o.financials.balance}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
            summaryY += 20;
            
            // Separator
            ctx.strokeStyle = "#DDDDDD";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(summaryBoxX + 30, summaryY);
            ctx.lineTo(summaryBoxX + summaryBoxWidth - 30, summaryY);
            ctx.stroke();
            summaryY += 40;
            ctx.textAlign = "left";
            
            // Total
            ctx.fillStyle = "#000000";
            ctx.font = "bold 40px Arial";
            ctx.fillText("Total Amount:", summaryBoxX + 30, summaryY);
            ctx.textAlign = "right";
            ctx.fillText(`‚Çπ${o.financials.total}`, summaryBoxX + summaryBoxWidth - 30, summaryY);
            summaryY += 45;
            
            // Payment Mode
            ctx.textAlign = "center";
            ctx.font = "28px Arial";
            ctx.fillStyle = "#666666";
            // Payment mode - show N/A if full balance pending
            const paymentMode = o.financials.advance > 0 ? (o.financials.mode || 'Cash') : 'N/A';
            ctx.fillText(`Payment Mode: ${paymentMode}`, summaryBoxX + summaryBoxWidth/2, summaryY);
            
            // ===== FOOTER WITH T&C =====
            y = summaryBoxY + summaryBoxHeight + 80;
            
            ctx.fillStyle = "#666666";
            ctx.font = "26px Arial";
            ctx.textAlign = "center";
            ctx.fillText('Terms & Conditions: "No guarantee on color restoration. No warranty on white shoes.', width/2, y);
            y += 40;
            ctx.fillText('Pre-existing damages are not covered."', width/2, y);
            
            y += 80;
            ctx.fillStyle = "#000000";
            ctx.font = "32px Arial";
            ctx.fillText("Thank you for choosing Mr Boot Shoe Laundry & Repair!", width/2, y);
            
            y += 60;
            ctx.fillStyle = "#25D366";
            ctx.font = "bold 38px Arial";
            ctx.fillText("Contact: +91 9028983659", width/2, y);
            
            // Download with HIGH QUALITY
            canvas.toBlob(blob => {
                const a = document.createElement('a');
                a.download = `invoice_${o.seqId}.png`;
                a.href = URL.createObjectURL(blob);
                a.click();
                setTimeout(() => {
                    if(confirm("Bill Downloaded. Open WhatsApp now?")) {
                        const whatsappNumber = o.customer.whatsapp || o.customer.phone;
                        window.sendWhatsApp(whatsappNumber, "Here is your service invoice. Please check the attached image.");
                    }
                }, 1000);
            });
            
            } catch(error) {
                console.error("Bill generation error:", error);
                alert("Error generating bill: " + error.message + "\nPlease check console for details.");
            }
        };

        // Stub functions for features not yet implemented
        window.toggleSelectMode = () => {
            window.isSelectMode = !window.isSelectMode;
            document.getElementById('btn-select-mode').innerText = window.isSelectMode ? "Cancel" : "Select";
            window.selectedOrders.clear();
            document.getElementById('bulk-actions-bar').classList.toggle('visible', false);
            window.renderOrders();
        };
        
        window.toggleOrderSelection = (id) => {
            if(window.selectedOrders.has(id)) {
                window.selectedOrders.delete(id);
            } else {
                window.selectedOrders.add(id);
            }
            document.getElementById('bulk-count').innerText = window.selectedOrders.size;
            document.getElementById('bulk-actions-bar').classList.toggle('visible', window.selectedOrders.size > 0);
            window.renderOrders();
        };
        
        window.performBulkAction = async (action) => {
            if(window.selectedOrders.size === 0) return;
            
            if(action === 'Ready') {
                if(!confirm(`Mark ${window.selectedOrders.size} orders as Ready?`)) return;
                for(const id of window.selectedOrders) {
                    await db.collection("orders").doc(id).update( { status: 'Ready' });
                }
                alert(`‚úÖ ${window.selectedOrders.size} orders marked as Ready!\n\nYou can now notify customers individually from the Orders list.`);
            } else if(action === 'Delete') {
                if(!confirm(`Delete ${window.selectedOrders.size} orders permanently?`)) return;
                for(const id of window.selectedOrders) {
                    await db.collection("orders").doc(id).delete();
                }
            }
            
            window.selectedOrders.clear();
            window.isSelectMode = false;
            document.getElementById('btn-select-mode').innerText = "Select";
            document.getElementById('bulk-actions-bar').classList.remove('visible');
            window.renderOrders();
        };
        
        // ===== AI ASSISTANT FUNCTIONS =====
        
        window.openAIAssistant = () => {
            document.getElementById('modal-ai-assistant').classList.add('open');
        };
        
        window.askAI = async (type) => {
            const prompts = {
                'price': 'Based on my recent orders, what should I charge for premium shoe cleaning with waterproofing?',
                'services': 'A customer brought in expensive leather boots. What services should I recommend?',
                'message': 'Write a professional follow-up message for customers who haven\'t picked up their orders',
                'report': 'Analyze my business performance and give me insights on how to improve'
            };
            
            document.getElementById('ai-input').value = prompts[type];
            window.sendAIMessage();
        };
        
        window.sendAIMessage = async () => {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            const chatContainer = document.getElementById('ai-chat-container');
            chatContainer.innerHTML += `<div class="ai-message ai-user">${message}</div>`;
            input.value = '';
            
            // Add loading message
            chatContainer.innerHTML += `<div class="ai-message ai-loading" id="ai-loading">Thinking...</div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Get business context
                const totalOrders = window.orders.length;
                const pendingOrders = window.orders.filter(o => o.status === 'Pending').length;
                const completedToday = window.orders.filter(o => {
                    const orderDate = new Date(o.timestamp);
                    const today = new Date();
                    return o.status === 'Completed' && 
                           orderDate.toDateString() === today.toDateString();
                }).length;
                
                // Calculate revenue
                const totalRevenue = window.orders
                    .filter(o => o.status === 'Completed')
                    .reduce((sum, o) => sum + (o.financials?.total || 0), 0);
                
                const context = `
Business Context:
- Total Orders: ${totalOrders}
- Pending Orders: ${pendingOrders}
- Completed Today: ${completedToday}
- Total Revenue: ‚Çπ${totalRevenue}
- Services Offered: ${ALL_SERVICES.slice(0, 10).join(', ')}

User Question: ${message}

Please provide helpful, specific advice for Mr Boot shoe laundry business.`;
                
                // Call AI API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: context
                        }]
                    })
                });
                
                const data = await response.json();
                
                // Remove loading message
                document.getElementById('ai-loading').remove();
                
                // Add AI response
                const aiResponse = data.content[0].text;
                chatContainer.innerHTML += `<div class="ai-message ai-assistant">${aiResponse.replace(/\n/g, '<br>')}</div>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
            } catch (error) {
                console.error('AI Error:', error);
                document.getElementById('ai-loading').remove();
                chatContainer.innerHTML += `<div class="ai-message ai-assistant">
                    ‚ö†Ô∏è AI feature needs setup. Here's what to do:<br><br>
                    <strong>Quick Answers Based on Your Data:</strong><br><br>
                    üìä <strong>Business Insights:</strong><br>
                    ‚Ä¢ Total Orders: ${window.orders.length}<br>
                    ‚Ä¢ Pending: ${window.orders.filter(o => o.status === 'Pending').length}<br>
                    ‚Ä¢ Revenue: ‚Çπ${window.orders.filter(o => o.status === 'Completed').reduce((sum, o) => sum + (o.financials?.total || 0), 0)}<br><br>
                    üí° <strong>Suggestions:</strong><br>
                    ‚Ä¢ Average order value: ‚Çπ${Math.round(window.orders.reduce((sum, o) => sum + (o.financials?.total || 0), 0) / window.orders.length) || 0}<br>
                    ‚Ä¢ Most popular service: ${ALL_SERVICES[0]}<br>
                    ‚Ä¢ Tip: Follow up on pending orders to improve completion rate!
                </div>`;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        };
        
        // ===== PUSH NOTIFICATIONS =====
        
        // Request notification permission on load
        window.requestNotificationPermission = async () => {
            if (!('Notification' in window)) {
                console.log('Browser does not support notifications');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            
            return false;
        };
        
        // Send push notification
        window.sendPushNotification = (title, body, icon = null) => {
            if (!('Notification' in window)) {
                console.log('Notifications not supported');
                return;
            }
            
            if (Notification.permission === 'granted') {
                try {
                    // Try simple notification first (works in most contexts)
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        // If service worker available, use it
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification(title, {
                                body: body,
                                icon: icon || 'https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png',
                                badge: 'https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png',
                                tag: 'mr-boot-notification',
                                requireInteraction: false
                            });
                        }).catch(err => {
                            console.log('Service worker notification failed:', err);
                        });
                    } else {
                        // Fallback to simple notification
                        new Notification(title, {
                            body: body,
                            icon: icon || 'https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png',
                            badge: 'https://i.ibb.co/0RsQmNW7/Shoe-Laundry-Logo-removebg-preview.png',
                            tag: 'mr-boot-notification',
                            requireInteraction: false
                        });
                    }
                } catch(err) {
                    console.log('Notification error:', err);
                    // Silently fail - notifications are nice-to-have
                }
            }
        };
        
        // Check due dates and send push notification
        window.checkDueDatesAndNotify = () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const dueOrders = window.orders.filter(o => 
                o.deliveryDate === tomorrowStr && 
                o.status !== 'Completed'
            );
            
            if (dueOrders.length > 0) {
                window.sendPushNotification(
                    '‚ö†Ô∏è Orders Due Tomorrow!',
                    `${dueOrders.length} order(s) need to be ready for pickup tomorrow`,
                    null
                );
            }
        };
        
        // Auto-check due dates every hour
        setInterval(() => {
            window.checkDueDatesAndNotify();
        }, 3600000); // Every hour
        
        // Check on load after 2 seconds
        setTimeout(() => {
            window.checkDueDatesAndNotify();
        }, 2000);
        
        // ===== VOICE COMMANDS =====
        
        let recognition = null;
        let isListening = false;
        
        // Initialize voice recognition
        window.initVoiceCommands = () => {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log('Voice recognition not supported');
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript.toLowerCase();
                console.log('Voice command:', command);
                window.processVoiceCommand(command);
            };
            
            recognition.onerror = (event) => {
                console.error('Voice recognition error:', event.error);
                isListening = false;
                const btn = document.getElementById('voice-btn');
                if (btn) btn.textContent = 'üé§';
            };
            
            recognition.onend = () => {
                isListening = false;
                const btn = document.getElementById('voice-btn');
                if (btn) btn.textContent = 'üé§';
            };
            
            return true;
        };
        
        // Toggle voice listening
        window.toggleVoiceCommand = () => {
            if (!recognition && !window.initVoiceCommands()) {
                alert('Voice commands not supported in your browser');
                return;
            }
            
            const btn = document.getElementById('voice-btn');
            
            if (isListening) {
                recognition.stop();
                isListening = false;
                btn.textContent = 'üé§';
            } else {
                recognition.start();
                isListening = true;
                btn.textContent = 'üî¥';
                window.sendPushNotification('Voice Command', 'Listening... Try saying "new order" or "show reports"');
            }
        };
        
        // Process voice commands
        window.processVoiceCommand = (command) => {
            if (command.includes('new order') || command.includes('create order')) {
                window.switchView('orders', document.querySelector('.nav-item'));
                alert('Voice command: Opening new order form');
            } else if (command.includes('report') || command.includes('reports')) {
                window.switchView('reports', document.querySelectorAll('.nav-item')[3]);
                alert('Voice command: Opening reports');
            } else if (command.includes('customer')) {
                window.switchView('customers', document.querySelectorAll('.nav-item')[1]);
                alert('Voice command: Opening customers');
            } else if (command.includes('gallery')) {
                window.switchView('gallery', document.querySelectorAll('.nav-item')[2]);
                alert('Voice command: Opening gallery');
            } else if (command.includes('inventory')) {
                window.switchView('inventory', document.querySelectorAll('.nav-item')[4]);
                alert('Voice command: Opening inventory');
            } else {
                alert(`Voice command not recognized: "${command}"\n\nTry:\n- "New order"\n- "Show reports"\n- "Open customers"\n- "Open gallery"`);
            }
        };
        
        // ===== GOOGLE SHEETS AUTO-EXPORT =====
        
        window.exportToGoogleSheets = async () => {
            // This function would integrate with Google Sheets API
            // For now, create CSV export
            const csvData = window.generateDailyCSV();
            
            // In production, you would send this to Google Sheets API
            console.log('Daily export data:', csvData);
            
            // For now, download as CSV
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mr_boot_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            window.sendPushNotification('Data Export', 'Daily data exported successfully');
        };
        
        // Generate CSV for daily export
        window.generateDailyCSV = () => {
            const today = new Date().toLocaleDateString();
            const todayOrders = window.orders.filter(o => o.date === today);
            
            let csv = 'Date,Order ID,Customer Name,Phone,WhatsApp,Items,Total,Advance,Balance,Status\n';
            
            todayOrders.forEach(o => {
                const items = o.items.map(i => `${i.brand} ${i.type}`).join('; ');
                csv += `"${o.date}","${o.seqId}","${o.customer.name}","${o.customer.phone}","${o.customer.whatsapp || o.customer.phone}","${items}",${o.financials.total},${o.financials.advance},${o.financials.balance},"${o.status}"\n`;
            });
            
            return csv;
        };
        
        // Schedule daily export at 12 AM
        window.scheduleDailyExport = () => {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // Midnight
            
            const timeUntilMidnight = tomorrow - now;
            
            setTimeout(() => {
                // Export at midnight
                window.exportToGoogleSheets();
                
                // Schedule next export (24 hours)
                setInterval(() => {
                    window.exportToGoogleSheets();
                }, 86400000); // 24 hours
            }, timeUntilMidnight);
            
            console.log('Daily export scheduled for midnight');
        };
        
        // Start daily export schedule on load
        window.addEventListener('load', () => {
            window.scheduleDailyExport();
            
            // Request notification permission
            setTimeout(() => {
                window.requestNotificationPermission();
            }, 3000);
        });
        
        // ===== PWA INSTALL PROMPT =====
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installBtn = document.getElementById('install-btn');
            if (installBtn) {
                installBtn.style.display = 'block';
                installBtn.onclick = async () => {
                    if (!deferredPrompt) return;
                    
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response: ${outcome}`);
                    
                    if (outcome === 'accepted') {
                        alert('üéâ App installed! You can now access Mr Boot from your home screen!');
                    }
                    
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                };
            }
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            alert('‚úÖ Mr Boot app installed! Access it from your home screen.');
        });
        
        // ===== SERVICE WORKER REGISTRATION =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
